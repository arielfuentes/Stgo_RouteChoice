---
title: "Propuesta Metodológica para la desagregación de demanda de Transporte Público del Sistema RED, aplicado al eje Norte-Sur de Santiago de Chile"
author: "Ariel Fuentes"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  officedown::rdocx_document:
    plots:
      style: Normal
      align: center
      caption:
       style: Image Caption
       pre: 'Figura '
       sep: ': '
    tables:
      style: Table
      layout: autofit
      width: 1.0
      caption:
       style: Table Caption
       pre: 'Tabla '
       sep: ': '
      conditional:
       first_row: true
       first_column: false
       last_row: false
       last_column: false
       no_hband: false
       no_vband: true
    reference_docx: template.docx
bibliography: library.bib
csl: iso690-numeric-cs.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tibble)
library(magick)
library(ganttrify)
library(officer)
library(kableExtra)
library(officedown)
library(tidyr)
library(ggplot2)
```

**UNIVERSIDAD DE SANTIAGO DE CHILE**

**FACULTAD DE INGENIERÍA**

**Departamento de Ingeniería Geográfica**

Propuesta Metodológica para la desagregación de demanda de Transporte Público del Sistema RED, aplicado al eje Norte-Sur de Santiago de Chile.

Nombre Alumno: Ariel Fuentes Díaz

Profesor Guía: Marcos Medina Tapia

Santiago-Chile

Segundo Semestre 2021

\newpage

<!---BLOCK_PORTRAIT_START--->

# RESUMEN

Para este trabajo de título se propone una metodología de redefinición de TAZ (del inglés, transportation analysis zone), es decir, de las Zonas de Análisis de Transporte. Esta metodología es desarrollada mediante el post-procesamiento de los datos masivos de tarjetas inteligentes (bip!), constituyéndose la ubicación geográfica, indicadores de calidad de viaje como tiempo de espera, tiempo de viaje, acceso, junto a otras variables espaciales como la densidad poblacional.
Se propone en esta metodología, que a través de ponderadores espaciales se puede clusterizar y redefinir zonas, las que serán de menor área y más homogéneas, que permitirán por una parte recuperar viajes intrazonales y por otro lado, facilitar y mejorar la calibración para un modelo de asignación de demanda de transporte público, donde se ha detectado que una de las principales barreras para mejorar dichos modelos, radica en su zonificación, la método a usar es una clusterización jerárquica y espacial por zona de una zonificación base (EOD 2012) y posterior poligonización de los respectivos clusters. 
Esta metodología hará que ese proceso sea más eficiente y abordable al ser bajo en costo de procesamiento y monetario. 
Para validar y demostrar los resultados de la metodología, se evaluarán modelos de asignación simplificados, utilizando primero con la zonificación de la EOD 2012 y posteriormente con la zonificación propuesta.

Palabras Claves: Zonas de Análisis de Transporte, Asignación de Transporte, Clusterización. 

\newpage

# ABSTRACT

For this title work, a methodology for redefining TAZ (from English, transportation analysis zone) is proposed, that is, of the Transportation Analysis Zones. This methodology is developed through the post-processing of massive data from smart cards (bip!), constituting the geographical location, trip quality indicators such as waiting time, travel time, access, along with other spatial variables such as density population.
It is proposed in this methodology that, through spatial weights, zones can be clustered and redefined, which will be smaller in area and more homogeneous, which will allow, on the one hand, to recover intrazonal trips and, on the other hand, to facilitate and improve the calibration for a model. of public transport demand allocation, where it has been detected that one of the main barriers to improving these models lies in their zoning, the method to use is a hierarchical and spatial clustering by zone of a base zoning (EOD 2012) and subsequent polygonization of the respective clusters.
This methodology will make this process more efficient and affordable as it is low in processing and monetary cost.
To validate and demonstrate the results of the methodology, simplified allocation models will be evaluated, first using the 2012 EOD zoning and later using the proposed zoning.

Keywords: Transport Analysis Zones, Transit Assignment, Clustering.

\newpage

# DEDICATORIA

\newpage

# AGRADECIMIENTOS

\newpage

# TABLA DE CONTENIDO

```{r, echo = F}
block_toc()
```

\newpage

# ÍNDICE DE TABLAS

```{r, echo = F}
block_toc(style = "Table Caption")
```

\newpage

# ÍNDICE DE FIGURAS

```{r, echo = F}
block_toc(style = "Image Caption")
```

\newpage

# INTRODUCCIÓN

En el presente trabajo de título se desarrollará una Propuesta Metodológica para la desagregación de demanda de Transporte Público. En particular, esta propuesta será aplicada para el eje Norte-Sur del sistema RED Movilidad. El objetivo de desarrollar esta propuesta es satisfacer la necesidad de *estimar la demanda desagregada de transporte público a bajo costo, que posea precisión táctica-operacional*. Como se verá en el capítulo 2, el mecanismo del modelo clásico de transporte, está sostenido en una zonificación, por tanto, para obtener la demanda de las rutas de transporte público en un periodo del día, es necesaria una matriz Origen - Destino a nivel zonal, que se conecta a través de sus centroides hacia los distintos nodos de la red de transporte, existiendo así un problema de agregación.  Por tanto, nuestra propuesta consiste en crear un nuevo esquema de zonificación, que no tan solo aumente la cantidad de zonas en el área de estudio, sino que considere una regularización del fenómeno espacial, disminuyendo la incertidumbre de la agregación. 

Lo antes mencionado, podrá ser logrado gracias a la disponibilidad de datos de Movilidad de manera desagregada, que disponemos en la era del *Big Data*, en este caso en particular, son las validaciones de viajes con tarjetas inteligentes; denominadas tarjeta *bip!*, más variables territoriales. Como consecuencia de ello, el análisis de estos datos en su dimensión espacial, permitirá la creación de modelo estadístico que entregue un mayor número de zonas regularizadas espacialemente para el área de estudio, que a bajo costo podrá elevar la precisión táctica-operacional de la demanda de transporte público.  

La estructura del trabajo se clasifica en:

- Justificación del Problema

- Marco Teórico de la Modelación de Demanda de Transporte Público

- Metodología

- Aplicación del Modelo

- Validación

- Análisis de Resultados

- Conclusiones y Recomendaciones

<!---BLOCK_PORTRAIT_STOP--->

\newpage

# CAPÍTULO 1: JUSTIFICACIÓN DE LA INVESTIGACIÓN

\newline

## 1.1 Antecedentes Generales

\newline

Desde 2007, el Sistema de Transporte Público de la ciudad de Santiago integra física y tarifariamente a la totalidad de los buses de transporte público urbano de la ciudad, operados por empresas privadas, al Metro de Santiago, y al sistema MetroTren Nos, a través de un único medio de acceso electrónico: la Tarjeta bip! @DTPM1.

Los Operadores de Uso de Vías son aquellas sociedades anónimas que prestan los servicios de Transporte Público mediante buses, bajo un sistema de concesión de uso de vías o modalidades análogas de regulación, actualmente existen 6 operadores en el sistema RED Movilidad @DTPM2.


````{r include = F}
UN <- tibble(Operador = c("Buses Vule S.A.", "Subus Chile S.A.", "Voy Santiago SPA", "Metbus S.A.", "Redbus Urbano S.A.", "Servicio de Transporte de Personas S.A."),
       Servicios = c("Unidad de Negocio 3", "Unidad de Negocio 2", "Unidad de Negocio 4", "Unidad de Negocio 5", "Unidad de Negocio 6", "Unidad de Negocio 7"))
````

```{r tab.cap='Empresas Operadoras', tab.id='op', first_column = TRUE, echo = F}
UN
````
Fuente: Elaboración Propia basado en @DTPM2.

Las modelaciones gubernamentales son encargadas al Programa de Vialidad y Transporte Urbano de la Subsecretaría del Ministerio del Transporte y Telecomunicaciones (SECTRA), cuyo énfasis es estratégico, utilizando escenarios de Desarrollo Urbano; quienes trabajan con información a nivel agregado mediante el uso de las Encuestas Origen Destino. Como señala @Willumsen2016, *"tanto el mundo académico como el profesional buscan activamente mejorar las bases de modelación de transporte. Entre las aproximaciones utilizadas se ha avanzado hacia modelos desagregados, donde incluso los modelos basados en actividades han llegado a eliminar el uso de zonas".*

Para evaluar en la dimensión de servicio de transporte, utilizando una matriz de viajes basadas en zonas de grandes dimensiones, la conectividad desde el centroide puede provocar que elija rutas infactibles, donde los parámetros de transbordos son difíciles de calibrar, distorsionando los resultados, incluso a nivel de modo. Esto puede ser resuelto mediante una zonificación más detallada, la cual permite identificar con mayor facilidad los desbalances en la calibración, porque al existir más centroides, el usuario puede elegir una gama más acotada de recorridos para realizar su viaje.  En @Altan2018 se encontró que al triplicar las zonas para el modelo de asignación de Estambul, el error se redujo un 23% y la correlación aumentó en 10 puntos.

Como el enfoque de las modelaciones gubernamentales es estratégico, estas utilizan la demanda a nivel agregado, por lo que, las empresas operadoras de transporte público requieren, un método de estimación de demanda desagregada que se pueda obtener a bajo costo; el cual posea una precisión táctica-operacional para su respectiva zona de operación. Que sea a bajo costo implica que no será necesario realizar un nuevo estudio de movilidad (Encuesta Origen - Destino) y que su respectiva zonificación sea rápida de generar a través de una modelación estadística. Una encuesta de movilidad es costosa, para la ciudad de Santiago la última EOD (2012) costó 600 millones (CLP) @EODCepal, y esta es realizada cada 10 años. 

## 1.2 Estado Actual del Problema

Tanto la red de transporte como la demanda, no es estable a través del tiempo. Por ello, las empresas operadoras necesitan: 

a) evaluar los impactos por modificaciones al Plan Operacional, 

b) predecir la demanda del siguiente año, para generar sus respectivos presupuestos, y 

c) renegociar contratos por afectación por otros modos.

````{r, echo = F}
fp_bold <- fp_text_lite(bold = TRUE)
fp_refnote <- fp_text_lite(vertical.align = "superscript")
bl <- block_list(fpar(ftext("Herramienta para análisis de datos masivos de transporte público", fp_bold)))
````

La forma en que generalmente se responde a tales incertidumbres es midiendo la demanda por inclusión o eliminación de paradas, datos que son provistos por ADATRAP `r run_footnote(x = bl, prop = fp_refnote)`;  sin considerar el efecto de red por las diversas modificaciones en el sistema. Se obtienen las transacciones promedio por tipo día y se calendariza para el siguiente año. Metodología poco clara, que puede ser un mix de las anteriores. Es necesaria una modelación apropiada que pueda ser desarrollada en corto plazo para responder a esta problemática. Las metodologías antes mencionadas, poseen un alto grado de incertidumbre, para ser consideradas suficientes para evaluar cambios al programa operacional, predecir la demanda del siguiente periodo y renegociación de contratos. Una metodología comúnmente aceptada, para medir la elasticidad del sistema de transporte, es el modelo clásico de transporte. Por dicha razón es que el Directorio Metropolitano de Santiago (DTPM) @DTPMModelo, ha licitado a través de SECTRA, modelos de asignación (4 etapa del modelo clásico de transporte) que sean capaces de estimar a un nivel táctico-operacional, a diferencia de las modelaciones que comúnmente realiza SECTRA. Estos están dispuestos en la página web del DTPM, temporalmente son distantes entre sí; que, al no tener buen nivel de actualización, les resta utilidad para aplicabilidad a las problemáticas que las empresas operadoras necesitan resolver. Adicionalmente, el costo de elaboración de estos es alto, tanto en tiempo como en dinero. El año 2016, DTPM licitó estudio de Mejoramiento y Actualización del Modelo de Asignación de viajes del Sistema Transantiago, adjudicándose por un monto que ascendió a 89.000.000 millones de pesos @Chilecompra, y que cuyos resultados se materializaron el año 2018.

\newline

## 1.3 Hipótesis

\newline

Es posible desagregar la demanda zonal utilizando metodología que implique bajo nivel de costo y precisión en la estimación de demanda a servicios, considerando la localización de paradas como indicador espacial de la concentración de demanda, la cual mejorará resultados de la asignación de rutas, con precisión táctico-operacional.

\newline

## 1.4 Objetivos

\newline

### Objetivo General

Construir un modelo espacial que desagregue la demanda de una zonificación base del año 2012, en microzonas para las zonas de análisis de transporte, que componen el eje Norte-Sur del Transporte Público de Santiago.

\newline

### Objetivos Específicos

i) Analizar la composición de los viajes del eje Norte-Sur del sistema RED a nivel zonal, utilizando los datos de las tarjetas inteligentes del año 2019 en el periodo Punta Mañana.

ii) Analizar el grado de ajuste de la demanda a rutas, en función de la zonificación actual mediante un modelo de estimación de demanda.

iii) Construir modelo espacial y asignación de demanda para cada zona en el área de análisis.

iv) Analizar la estructura espacial de zonas (obtenidas en iii)), composición de los viajes intrazonales e interzonales y accesibilidad.

v) Evaluar la precisión táctica-operacional para modelo propuesto en la nueva configuración de zonas de análisis de transporte.

\newpage

# CAPÍTULO 2: MARCO TEÓRICO

## 2.1 La Demanda de Transporte

La demanda de servicios del transporte es altamente cualitativa y diferenciada @Ortúzar2008. Existe una amplia gama de demandas específicas de transporte que se diferencian por hora del día, día de la semana, motivo del viaje, tipo de mercancía, importancia de la velocidad y frecuencia, etcétera. Un servicio de transporte sin los atributos que permitan satisfacer esta demanda diferenciada puede ser totalmente inútil. Estas características hacen más difícil analizar y predecir la demanda por servicios de transporte: las ton/km y los pasajeros/km son unidades de rendimiento extremadamente gruesas que esconden una inmensa gama de requerimientos y servicios. La demanda de transporte es una demanda derivada, es decir, no es un fin en sí misma. Con la posible excepción del turismo, la gente viaja para satisfacer ciertas necesidades en sus destinos (trabajo, salud, entretenimiento). Esto es aún más cierto en el caso de las mercancías. Para comprender la demanda de transporte es importante analizar cómo están distribuidas en el espacio las facilidades para satisfacer estas necesidades humanas e industriales, tanto en contextos urbanos como regionales. Es evidente que un buen sistema de transporte amplía las oportunidades para satisfacer dichas necesidades, así como un sistema muy congestionado o mal conectado limita las opciones de movilidad y, por tanto, el desarrollo económico y social. La demanda de transporte tiene lugar en relación al espacio. Aunque parece trivial, es la distribución de las actividades en el espacio lo que provoca la demanda de transporte. Existen algunos problemas de transporte que se pueden tratar, a un nivel muy agregado, sin considerar explícitamente el espacio. Sin embargo, en la gran mayoría de los casos, el tratamiento explícito del espacio es inevitable y muy deseable. El enfoque más usual para tratar el espacio consiste en dividir el área de estudio en zonas y codificarlas, junto a las redes de transporte, de una forma adecuada para su procesamiento y tratamiento con la ayuda de paquetes computacionales especializados (software). En algunos casos, el área de estudio puede ser descrito simplificadamente, suponiendo que las zonas de interés forman un corredor que puede ser representado mediante un sistema lineal. En ambos casos existen diferentes métodos para tratar la distancia y/o distribuir orígenes y destinos (y sus atributos) en el espacio, los cuales son elementos esenciales del análisis de transporte. La articulación espacial de la demanda frecuentemente provoca problemas de falta de coordinación del sistema, la cual puede influir, de forma relevante, en el equilibrio entre oferta y demanda de transporte. Por ejemplo, un servicio de taxis puede tener una fuerte demanda no satisfecha en una parte de la ciudad, mientras en otras existen muchos taxis buscando clientes. Por otro lado, la concentración de población y actividad económica en corredores bien definidos puede justificar un sistema de transporte masivo de alta capacidad que quizás no sería defendible en áreas geográficas con menor densidad de actividades. Finalmente, la oferta y demanda de transporte tienen elementos dinámicos muy potentes. Una parte importante de la demanda de viajes de transporte se concentra especialmente, durante unas pocas horas del día, en áreas urbanas coincidentemente con los momentos de mayor congestión de tráfico (horas punta). Esta característica de variabilidad de la demanda en el tiempo hace que su análisis y cálculo de previsiones sean más difíciles y a la vez también más interesantes de estudiar. Puede ser que un sistema de transporte funcione adecuadamente para la demanda promedio de viajes pero que se colapse durante la hora punta. Existen varias técnicas para tratar de repartir la carga de la hora punta de una red: flexibilizar los horarios de trabajo, partir la jornada laboral, tarificación por congestión, etc. Sin embargo, la variación de demanda entre las horas punta y valle sigue siendo un problema central y fascinante de la modelización y planificación del transporte.

## 2.2 Oferta de Transporte

La primera característica de la oferta de transporte es @Ortúzar2008 que es un servicio y no una mercancía; por lo tanto, no se puede almacenar para ser utilizada cuando exista una demanda mayor. Un servicio de transporte tiene que ser consumido cuándo y dónde se produce, si no, pierde su beneficio. Por esta razón es muy importante estimar la demanda con la mayor precisión posible para así ahorrar recursos ajustando la oferta de servicios de transporte a ella. Muchas características de los sistemas de transporte provienen de su naturaleza como servicio. En términos muy generales, un sistema de transporte requiere un número de activos fijos (la infraestructura) y un número de unidades móviles (los vehículos). Es la combinación de ambos, junto con una serie de normas para su operación, lo que posibilita el movimiento de personas y mercancías. Frecuentemente se da el caso de que la infraestructura y/o los vehículos de transporte no son propiedad ni son operados por la misma empresa o grupo de empresas. Esto sucede en la mayoría de los modos de transporte, con la excepción notable de muchos sistemas ferroviarios. La separación entre el gestor de infraestructura y el gestor del servicio final de transporte genera una serie de interacciones suficientemente complejas entre entidades o Administraciones Públicas (estatales, regionales y/o locales), empresas de construcción, empresarios, operadores de transporte, viajeros, transportistas y público en general. Este último juega diversos papeles en la oferta de servicios de transporte, ya que con sus demandas puede influir en la puesta en marcha o no, de nuevos servicios que satisfagan sus necesidades dotando así, por ejemplo, de accesibilidad a un territorio y fomentando a la vez el desarrollo y la actividad económica. La provisión de infraestructura de transporte es particularmente importante desde el punto de vista de la oferta. La infraestructura de transporte es un “sistema unitario”, en el sentido de que no se puede concebir media pista de aterrizaje o la tercera parte de una estación de ferrocarril. Ciertamente, en algunos casos, puede haber razones suficientes para proveer gradualmente infraestructura a medida que crece la demanda. Por ejemplo, se puede empezar con una carretera sin pavimento, mejorarla más adelante con una o dos vías mediante un tratamiento superficial; luego una carretera sencilla o autovía bien construida, para finalizar con una carretera a nivel de autopista. De esta forma, la provisión de la infraestructura puede ajustarse y adecuarse a la demanda, evitándose así tempranas inversiones en instalaciones costosas innecesarias. Esto no es tan sencillo en otras áreas como, por ejemplo, aeropuertos, líneas ferroviarias, de metro, etcétera. A este respecto es necesario indicar que las últimas tendencias en la planificación del transporte van dirigidas hacia la gestión de la demanda en entornos de movilidad sostenible. El espacio es limitado pero el crecimiento de la demanda no lo es tanto. Por ello, puede ser interesante, en lugar de crecer en infraestructuras, proceder a una mejor optimización de los recursos existentes gestionando adecuadamente la demanda en modos y formas diferentes a los utilizados en las últimas décadas. Por otro lado, las inversiones en infraestructura del transporte no solamente son enormes sino que también su puesta en servicio lleva un tiempo considerable. Normalmente se trata de proyectos grandes y desde que comienza su planificación hasta que se implementan pueden pasar entre 5 y 15 años. Este aspecto es incluso más crítico en áreas urbanas en las que cualquier construcción y/o reparación de infraestructura de transporte, puede provocar serias perturbaciones, cuyas repercusiones en los usuarios y no usuarios son evidentes.

Además, las inversiones en transporte tienen un componente político muy importante. Por ejemplo, en los países en desarrollo los políticos normalmente consideran los proyectos de carreteras como algo seguro electoralmente: demuestran que hacen algo y es difícil que los medios de comunicación puedan demostrar errores. En países industrializados, en cambio, los proyectos de transporte normalmente conllevan el riesgo de polemizar con los residentes afectados o con los usuarios que sufren debido a la congestión y a los retrasos en obras sobrepasadas por la demanda. El juicio político es esencial en este tipo de disyuntivas, pero cuando no está apoyado por una planificación exhaustiva, las decisiones resultan ser una reacción rápida y, en general, poco reflexiva al problema y al momento de crisis; en el caso del transporte esto es, inevitablemente, “demasiado tarde”. En estos casos, la reflexión y la planificación son esenciales. En los 80, el énfasis en medidas tácticas de gestión de transporte a corto plazo reflejaba tanto una desconfianza en la modelización como un intento de evitar los problemas políticos, y una incapacidad a la hora de pensar estratégicamente acerca del futuro del sistema de transporte. La separación entre los que proveen infraestructura y los que ofrecen servicios introduce también complejidades desde el punto de vista económico. Para empezar, no siempre está claro que todos los usuarios perciban realmente los costes totales incurridos en la provisión de los servicios que ellos usan. Por ejemplo, prácticamente nunca se paga directamente por el espacio físico ocupado por las carreteras y cuando se hace, no se incluyen los costes de congestión u otras externalidades; posiblemente lo más cercano a esto son las autopistas de peaje y los modernos esquemas de tarificación vial. Los impuestos sobre vehículos y combustibles son solamente una aproximación genérica al pago por la provisión de infraestructura. Pero, ¿son importantes estas cuestiones? ¿no ocurre quizás que otros bienes y servicios como los parques públicos, las bibliotecas, la policía son a menudo proporcionados sin realizar ningún pago directo? ¿Qué problema hay en permitir la libre utilización económica de las calles? La teoría económica básica nos enseña que sí importa. En un mercado perfecto, una buena asignación de recursos para satisfacer las necesidades humanas solamente se consigue cuando los costes marginales de los bienes son iguales a su utilidad marginal. Por eso, a menudo se dice que el precio de los bienes y servicios, es decir, su coste percibido, debería fijarse según su coste marginal. Por supuesto, los mercados reales no son perfectos y la capacidad para pagar no es un buen indicador de necesidad; sin embargo, este marco general proporciona una base para contrastar otras formas de organizar el sistema de precios y su impacto en la asignación de recursos. El transporte es un elemento muy importante en el bienestar de los países y sus habitantes. Si los usuarios que utilizan la infraestructura de transporte no perciben las consecuencias de sus elecciones en términos de recursos, probablemente van a generar un equilibrio ineficiente entre oferta y demanda. Se despilfarrarán recursos, escasos al ser tarificados por debajo de su coste real, mientras que recursos más abundantes pero tarificados podrían no ser utilizados. El hecho de que globalmente algunos sectores de la economía (típicamente los dueños de vehículos privados) paguen más de lo necesario (a través de impuestos, tasas, combustibles, etc.) por el uso de infraestructura, no garantiza una asignación de recursos más racional. Los propietarios de coches probablemente ven estos costes anuales como costes fijos (a fondo perdido) y como mucho afectan en su decisión de comprar un coche, pero no de utilizarlo.En los países industrializados, sobre todo, las subvenciones entre usuarios se producen de forma “cruzada” no sólo entre modos (los impuestos del combustible pueden usarse para subvencionar el ferrocarril) sino dentro del mismo modo (los costes de mantenimiento de las carreteras son pagados mucho más ampliamente por los coches en función de lo que deterioran, que lo que pagan los vehículos pesados que, evidentemente, deterioran mucho más). Comparados con los vehículos pesados, los coches contribuyen más a los costes de mantenimiento de una carretera (de peaje o no) que el deterioro que ambos generan. Otro elemento de distorsión proviene de los efectos secundarios asociados a la producción de servicios de transporte: accidentes, contaminación y degradación del medioambiente en general. Estos efectos normalmente no son internalizados; el usuario del sistema de transporte raramente percibe el coste medioambiental o los gastos derivados de las hospitalizaciones de los heridos en accidentes relacionados con el transporte. Internalizar estos costes también podría ayudar a mejorar la toma de decisiones en planificación de transporte y, por tanto, a mejorar la asignación de la demanda hacia modos alternativos. Una de las características más importantes de la oferta de transporte es el grado de congestión al que se ha llegado últimamente, sobre todo en áreas urbanas y en algunas infraestructuras interurbanas. Es difícil definir la congestión objetivamente aunque todos sabemos cuándo la sufrimos. Hay aquí un problema de “percepción”, ya que de sobra es conocido que lo que se considera congestión excesiva en ciudades como Leeds o Lleida frecuentemente se consideraría normal en Londres o Lagos. La congestión surge cuando la intensidad de la demanda se aproxima a la capacidad de la instalación (calle, carretera, estación, etc.) y el tiempo requerido para utilizarla (viajar a través de ella) sobrepasa muy por encima la media establecida bajo condiciones de baja demanda. En el caso de la infraestructura de transporte, la inclusión de un vehículo adicional en el sistema genera un retraso suplementario a todos los demás usuarios, como puede verse, por ejemplo \@ref(fig:cong)

```{r, echo=FALSE}
img.file <- file.path("Congestión.png")
fpar_1 <- fpar(external_img(src = img.file, height = 4, width = 5))
````

````{r, echo = F, fig.cap="Congestión y sus efectos externos", fig.id = "cong", fig.cap.style = "Image Caption", fig.topcaption=TRUE}
fpar_1
````
Fuente: Sacado de @Ortúzar2008

Obsérvese que la contribución de un vehículo adicional al retraso de todos los usuarios es mayor cuando la intensidad de flujo vehicular es más alta. Este efecto externo, motivado por el fenómeno de la congestión, es generalmente percibido por los demás usuarios pero no por el conductor que lo origina. Éste es el coste que se intenta internalizar mediante sistemas como la tarificación vial electrónica, con el objetivo de ayudar en la toma de decisiones individuales más razonadas.

## 2.3 Estado de Equilibrio

En términos generales, dado un sistema de transporte con una cierta capacidad
de operación, la función de la planificación del transporte es asegurar la
satisfacción de una cierta demanda *D* de movimiento de personas y mercancías
con diferentes motivos de viaje, en distintos momentos del día, semana, mes y
año, utilizando los distintos modos que lo conforman @Ortúzar2008. El sistema de transporte
se puede definir como la interacción de:

a) Una infraestructura (p. ej., la red de transporte).

b) Un sistema de gestión (esto es, un conjunto de normas, como p. ej., conducir
por la derecha y una serie de estrategias de control, como las señales de
tráfico, etc.).

c) Un conjunto de modos de transporte y sus operadores.

Considérense un conjunto de volúmenes de tráfico V sobre una red, a una
velocidad *S* y con una capacidad de operación *Q* de acuerdo a un sistema de
gestión *M*. En términos muy generales, la velocidad sobre la red puede ser
representada como:

$S = f(Q,V,M)$ (2.1)

La velocidad puede ser considerada como una primera aproximación de un indicador general del *nivel de servicio* ofrecido por el sistema de transporte. En términos más generales, un nivel de servicio sería especificado como una combinación de varios efectos: velocidad o tiempo de viaje, tiempos de espera y caminata y precio. El sistema de gestión M puede incluir esquemas de gestión del
tráfico, control de áreas de tráfico y/o regulaciones aplicables a cada modo. 

Como en el caso de la mayoría de los bienes y servicios, se espera que el
nivel de demanda D dependa del nivel de servicio ofrecido por el sistema de
transporte y también de la distribución de las actividades A en el espacio:

$D = f({S,A})$ (2.2)

Para un sistema de actividades fijo resulta que combinando las ecuaciones
(2.1) y (2.3) se debería encontrar un conjunto de puntos de equilibrio entre la oferta y la demanda de transporte. Pero al variar el nivel de servicio en el espacio y en el tiempo, el sistema de actividades probablemente cambiará, determinando dos conjuntos diferentes de puntos de equilibrio: a corto y a largo plazo. El objetivo de la planificación del transporte es prever y gestionar la evolución en el tiempo de estos puntos de equilibrio de forma que se maximice
el bienestar social. 


Algunas relaciones causa-efecto muy simples se pueden representar gráficamente
para ayudar a comprender la naturaleza de algunos problemas de
transporte. Un ejemplo típico es el círculo vicioso coche/transporte público.

````{r, echo=FALSE}
img.file <- file.path("circulo vicioso.png")
fpar_2 <- fpar(external_img(src = img.file, height = 4, width = 5))
````

````{r, echo = F, fig.cap="Círculo Vicioso del transporte público", fig.id = "vicioso", fig.cap.style = "Image Caption", fig.topcaption=TRUE}
fpar_2
````
Fuente: Sacado de @Ortúzar2008

El crecimiento económico trae como consecuencia, entre otros aspectos, un aumento en la compra de vehículos privados.
Inicialmente, más coches significan, en general, que más personas desean transferirse
del transporte público al coche, lo cual implica evidentemente menos
pasajeros. A ello, los operadores pueden responder incrementando los precios
de los billetes y/o reduciendo la frecuencia (el nivel del servicio) o ambos. En
consecuencia, la situación descrita hace más atractiva la posesión y uso del
coche privado, acelerando así el círculo vicioso. A medida que este proceso se
repite cada año, los niveles de congestión aumentan, los autobuses se retrasan,
sus frecuencias disminuyen y sus tarifas son cada vez más altas; se constata,
por tanto, que la acumulación de decisiones individuales razonables, provoca
un estado final peor para todos que el inicial.

Medidas estructurales (físicas) como el establecimiento de
carriles bus y otras medidas de prioridad a buses son particularmente atractivas,
ya que dan como resultado una asignación más eficiente del espacio vial.
Por otro lado, las subvenciones al transporte público tienen sus detractores y
sus defensores; pueden reducir la necesidad de subir los precios a corto plazo,
pero tienden a generar grandes déficits y a proteger una gestión “pobre”, que
es en parte consecuencia de su propia ineficacia. Este aspecto últimamente
ha hecho que, en países en los que el transporte público se ejerce, por parte
de empresas u operadores privados en base a concesiones (España, p. ej.), las
licitaciones se realicen en función de lo que se denomina “Contratos de Gestión
Interesada”, en los cuales se exige y vigila al empresario en el cumplimiento
de ciertos estándares de calidad (puntualidad, frecuencias, comportamiento y
atención al usuario, adaptabilidad de bus, edad del bus, etc.), de forma que sus
ingresos aumenten si dichos estándares se cumplen, penalizando a aquellos
empresarios que no los cumplen.

Desgraciadamente, es imposible caracterizar todos los problemas de transporte
de una forma sencilla, única y universal. Los problemas de transporte
dependen del contexto, el cual no puede ignorarse a la hora de resolverlos. Los
modelos pueden contribuir a lograr que la identificación de los problemas y la
selección de la forma de resolverlos tenga una base más sólida @Ortúzar2008.

## 2.4 Modelación Agregada y Desagregada

El nivel de agregación seleccionado para la medición de los datos es una cuestión
importante en el diseño general de un estudio de planificación de transporte @Ortúzar2008.
Aunque un nivel mayor de detalle –con miras a un mayor grado de
exactitud– debería mejorar la calidad de los modelos, probablemente incrementará
los costes de recogida y análisis de datos así como de la mayoría de
los restantes aspectos del ejercicio de la modelización.
De interés central es la agregación de los datos exógenos, es decir, la información
acerca de cuestiones diferentes al comportamiento de los viajeros,
que se supone endógeno (es decir, el modelo intenta replicarlo). Por ejemplo,
durante años se ha discutido si un ítem de datos representa el valor medio de
un grupo de viajeros o si debería ser recogido específicamente para un individuo.
Es inevitable un cierto grado de agregación cuando el modelo de interés
procura representar el comportamiento de más de un individuo. Pero, cuando el modelo de interés
intenta representar el comportamiento individual, como es el caso de los modelos desagregados o de segunda generación, es lógico pensar que la información exógena pueda ser obtenida y utilizada
separadamente para cada viajero. Una cuestión importante es entonces si, por
razones de coste u otras, se debería preferir utilizar datos menos detallados
(ver @Daly1990).
La previsión de la demanda futura es un elemento crucial en la mayoría
de los estudios de planificación del transporte. El ser capaz de predecir el
uso más probable de nuevas infraestructuras es un precursor esencial para
la toma de decisiones racional acerca de las ventajas o no de proveer tales
infraestructuras. También puede ser importante tener alguna idea acerca de
la sensibilidad de la demanda respecto a variables importantes que estén bajo
control del analista (p. ej., la tarifa que se cobra por su uso). En la mayoría de
los casos las previsiones y los estudios de sensibilidad deben proporcionarse
a nivel agregado, es decir, deben representar el comportamiento del total de
la población de interés. Por lo tanto, con el fin de obtener estos indicadores
el analista que utiliza modelos desagregados tiene que encontrar un método
robusto para agregar los resultados del modelo.
Los modelos de la primera generación se solían utilizar casi sin excepción
en los estudios de transporte hasta finales de los 70; llegaron a hacerse
familiares, necesitaban relativamente pocas habilidades por parte del analista
(pero sí algún conocimiento de informática básica) y tenían la propiedad de
ofrecer una “receta” para todo el proceso de modelización completo, desde la
recolección de datos hasta la predicción de flujos en los enlaces de una red.
Los resultados de estos modelos, quizás porque eran generados por complicados
programas de ordenador, a menudo se consideraban más exactos de lo que
se pretendía; por ejemplo, predecir giros a izquierda de vehículos a 15 años
vista. Los modelos de la primera generación han sido criticados severamente
(a veces con justificación) por su inflexibilidad, inexactitud y coste. Desgraciadamente,
muchos enfoques de la segunda generación, habiendo adoptado
un tratamiento sofisticado de las elecciones y restricciones enfrentadas por los
viajeros individuales, han fallado al momento de realizar previsiones, a veces
porque requerían datos que no podían ser estimados de forma razonable.
Los modelos desagregados, que llegaron a ser muy populares en los 80,
ofrecen sustanciales ventajas sobre los métodos tradicionales y también son
de utilidad práctica en múltiples aplicaciones. Sin embargo, un problema práctico
importante es que requieren un alto nivel de conocimiento y “habilidades”
estadísticas y econométricas (especialmente en la interpretación de los resultados), y definitivamente mucho mayor que en el caso de los modelos agregados.
Además, se ha exagerado la diferencia entre los modelos de primera
y segunda generación. Por ejemplo, los modelos desagregados fueron inicialmente
promocionados como radicalmente diferentes a los métodos clásicos,
una “revolución” en este campo del conocimiento. Sin embargo, bastante más
tarde quedó claro que era más adecuado considerarlos una “evolución” desde un
punto de vista de modelización @Williams1982b. De hecho,
en muchos casos, existe una equivalencia completa en la forma de pronosticar @Daly1982a.
La diferencia esencial está en el tratamiento de la descripción del comportamiento,
en particular durante el proceso de desarrollo del modelo; en muchos
casos, el enfoque desagregado es claramente superior al conjunto de comportamientos
individuales por zonas y estratos predefinidos de la población.
Los intentos de clarificar el tema de en qué circunstancias sería preferible
utilizar un enfoque agregado o desagregado, han llegado a la conclusión de que
no existe un enfoque más adecuado para todas las situaciones planteadas @Daly1990. Estos intentos también han concluido que se requiere una serie de directrices para ayudar a los profesionales desesperados a elegir la herramienta de modelización más apropiada para un contexto determinado. En este libro se ha intentado dar respuesta a esta cuestión.

## 2.5 Modelo Clásico de Transporte

Años de experimentación y desarrollo han dado como resultado la definición de
una estructura general de modelización denominada modelo clásico de transporte.
Esta estructura es, en efecto, el resultado de la práctica en los 60, pero
ha permanecido relativamente inalterada a pesar de las importantes mejoras
experimentadas en las técnicas de modelización durante los últimos 40 años.
La forma general del modelo puede verse en la siguiente figura. 


````{r, echo=FALSE}
img.file <- file.path("Modelo Clásico.png")
fpar_3 <- fpar(external_img(src = img.file, height = 4, width = 5))
````

````{r, echo = F, fig.cap="Modelo Clásico de Transporte", fig.id = "4etapas", fig.cap.style = "Image Caption", fig.topcaption=TRUE}
fpar_3
````
Fuente: Sacado de @Ortúzar2008

El enfoque comienza considerando una zonificación y un sistema de redes así como la recogida
y codificación de datos de planificación, calibración y validación. Estos
datos deberían incluir información para el año base sobre la población de diferentes
tipos en cada zona del estudio así como niveles de actividad económica,
incluyendo empleo, espacio dedicado a la actividad comercial, instalaciones de
educación y recreativas @Ortúzar2008. A continuación estos datos se utilizan como variables
independientes de la función de demanda, para estimar modelos que reproduzcan
el número total de viajes atraídos y generados (variable dependiente) por
cada zona del área de estudio (generación de viajes). El paso siguiente es asignar
estos viajes a diferentes destinos, en otras palabras, su distribución en el
espacio, dando lugar a una matriz de viajes origen-destino (O-D). La etapa siguiente
consiste en modelizar la elección del modo, y esto tiene como resultado
el reparto o distribución modal, es decir, la asignación de los viajes de la matriz
O-D según los diferentes modos de transporte. Finalmente, la última etapa del modelo clásico consiste en la asignación de los viajes en cada modo a su red correspondiente: típicamente de transporte público o de transporte privado.

El modelo clásico se presenta como una secuencia de cuatro etapas o submodelos:
generación de viajes, distribución, reparto modal y asignación. Actualmente
se reconoce que las decisiones de viaje no se toman realmente siguiendo
este tipo de secuencia; una visión contemporánea es que el posicionamiento de
cada submodelo depende de la forma de la función de utilidad asumida para
explicar todas estas elecciones de viaje @Williams1977. Más aún, se
critica que el modelo de cuatro etapas concentra la atención en sólo un espectro
limitado de las decisiones que pueden adoptar los usuarios. La tendencia actual
requiere analizar una gama más amplia de respuestas a los problemas y proyectos
de transporte. Por ejemplo, ante una situación de congestión creciente,
un viajero puede responder con una serie de cambios simples en:

- El *recorrido* seguido, para evitar la congestión o aprovechar nuevos enlaces;
esto incluye la elección de aparcamiento o una combinación de servicios en el caso de transporte público.

- El *modo* utilizado para llegar al destino.

- La *hora* de salida para evitar los momentos más congestionados.

- El *destino* del viaje hacia una zona menos congestionada.

- La *frecuencia* de los viajes, haciéndolos otro día, o quizás combinándolos
con otras actividades.

Además, a más largo plazo pueden tener lugar otras respuestas más complejas,
por ejemplo, cambio de lugar de empleo, de localización residencial, de
áreas comerciales, etc.; todos estos aspectos son sensibles, al menos en parte,
a cambios en la accesibilidad del sistema de transporte.
A pesar de estos comentarios, el modelo secuencial de cuatro etapas constituye
un punto de referencia respecto a métodos alternativos. Por ejemplo,
algunos de los enfoques actuales intentan tratar de forma simultánea la elección
de frecuencia de viaje (viajes por semana), destino y modo de viaje en un
modelo único que colapsa estas tres etapas. Otros enfoques ponen el énfasis
en el papel de las actividades familiares y en las elecciones de viaje que ellas
originan; conceptos como circuitos, presupuestos de tiempo y dinero se utilizan
en este contexto para modelizar las decisiones y restricciones de viaje. Estas
estrategias de modelización son más difíciles de plantear en términos de los
cuatro submodelos o decisiones anteriormente descritas. Hasta el momento,
estos nuevos enfoques han jugado un papel más bien de investigación y su
uso operativo parece aún lejano. Sin embargo, estos modelos basados en las
actividades permiten una mejor comprensión del comportamiento respecto
a viajes y probablemente en el futuro mejoren los enfoques de modelización
más convencionales.
La secuencia generación-distribución-elección modal-asignación es la más
común pero no es la única posible. Por ejemplo, algunos estudios en el pasado
han situado la elección modal antes que la distribución e inmediatamente
después de (o junto con) la generación de viajes. Esto permite dar un mayor
énfasis a las variables decisionales que dependen de la unidad que genera el
viaje, quizás el hogar. Sin embargo, situar la elección modal antes de que se
conozca la distribución dificulta la inclusión en el modelo de los atributos del
viaje y del modo y le resta relevancia en términos de análisis de políticas al
modelo de reparto modal. Quizás un mejor enfoque sería tratar simultáneamente
la distribución y elección del modo.
Obsérvese también que el modelo clásico considera a la generación de viajes
como inelástica, es decir, es independiente del nivel de servicio proporcionado
por el sistema de transporte. Probablemente, ello no es demasiado realista pero 
solamente en los últimos años se han desarrollado técnicas que pueden tener
en cuenta estos efectos de forma sistemática.
Una vez calibrado y validado el modelo según las condiciones del año
base es cuando puede ser aplicado a uno o más horizontes de planificación.
Para hacer esto se deben plantear escenarios y planes que describan
las características relevantes del sistema de transporte y las variables de planificación
en situaciones futuras. La elaboración de escenarios realistas y
consistentes no es tarea fácil, ya que es muy sencillo caer en la trampa de construir
alternativas futuras que no sean financieramente factibles ni realistas
en cuanto al probable desarrollo de los usos del suelo y de las actividades en
la zona de estudio. A pesar de estas dificultades, establecer escenarios es aún
más un arte que una técnica y requiere mucha experiencia ingenieril combinada
con un sólido juicio político; desgraciadamente, éstos son recursos
escasos que no suelen encontrarse al mismo tiempo en los equipos de planificación.
Una vez definidos un conjunto de escenarios y planes realistas para su
verificación, se activa nuevamente la misma secuencia de modelos para simular
sus prestaciones. A continuación se realiza una comparación entre los costes
y beneficios de los diferentes proyectos bajo diferentes escenarios, con el
objetivo final de elegir el programa de inversión más rentable y la política de
transporte más adecuada que satisfaga la demanda por desplazamientos en la
zona de estudio.
Una cuestión importante en el modelo clásico de cuatro etapas es la necesidad
de verificar la utilización consistente de las variables que influyen
sobre la demanda. Por ejemplo, al final de la fase de asignación de tráfico se
obtendrán nuevos niveles de flujo y, por lo tanto, nuevos tiempos de viaje que,
probablemente, no sean los mismos tiempos de viaje supuestos al estimar la
distribución de viajes y elección de modo. Por ello parecería necesario volver a
ejecutar los modelos de distribución y elección modal basándose en los nuevos
tiempos de viaje deducidos de la asignación, recalcular las nuevas matrices
modales y utilizarlas para la aplicación, también de nuevo, del modelo de
asignación y así sucesivamente. Desafortunadamente, en general este proceso
iterativo ingenioso, no conduce a un conjunto estable de modelos de distribución,
elección modal y asignación con tiempos de viaje consistentes. 

## 2.6 Redes y Zonificación

Una de las primeras y más importantes decisiones a las que tiene que enfrentarse
el profesional de la modelización de transporte es el nivel de detalle
(resolución) que se va a adoptar en el estudio @Ortúzar2008. Este problema tiene varias dimensiones:
esquemas de redes y servicios a considerar, tipo de variables de
comportamiento que se incluirán, tratamiento del tiempo, etc. Este epígrafe
concentra su atención en establecer consideraciones de diseño relativas a dos
de estas decisiones: la definición de la zonificación y de la red.
En estos dos casos, al igual que en otros aspectos fundamentales de la modelización
de transporte, la opción finalmente elegida refleja un compromiso
entre dos objetivos en conflicto: la exactitud y el coste. Se puede alcanzar una
gran exactitud utilizando una zonificación más detallada y un sistema de redes
más preciso. En el límite, esto implicaría reconocer cada hogar de cada uno de
los individuos, su localización, distancia a los puntos de acceso a las redes, etc.
Con una muestra suficientemente grande (tasa del 100% durante varios días), se
podría lograr una representación muy precisa del sistema actual. Sin embargo
el problema de estabilidad temporal debilita esta visión de la exactitud, ya que
se necesitaría predecir, con el mismo nivel de detalle, los cambios a nivel de
cada hogar individual que afectarían a la demanda de transporte. Esta tarea
es imposible e innecesaria. Cuando se realizan prognosis es posible admitir
menores niveles de detalle no sólo por motivos económicos, sino por el nivel
de exactitud requerido.

### 2.6.1 Diseño de la Zonificación

La zonificación se utiliza para agregar hogares individuales y edificios en
porciones tratables del territorio para los objetivos de la modelización. Las
dos dimensiones principales de una zonificación son el número de zonas y
su tamaño y, evidentemente, ambas están relacionadas. Cuanto mayor sea el número de zonas, obviamente más pequeñas deberán ser para cubrir la misma
área de estudio. En el pasado ha sido una práctica común desarrollar un
sistema de zonificación específico para cada estudio y para cada contexto de
decisión. Esto es claramente despilfarrador si se realizan distintos estudios en
áreas cercanas. Además, la introducción de sistemas zonales diferentes hace
difícil la utilización de datos de estudios previos y las comparaciones de modelos
en el tiempo.
La primera decisión al establecer un sistema de zonificación es distinguir
el área de estudio como tal del “resto del mundo”. Existen algunas ideas que
pueden facilitar esta elección:
Al elegir el área de estudio se debe considerar el contexto •• de decisión, la
red de transporte que debe ser modelizada y la naturaleza de los viajes
que interesan, es decir, si son obligatorios u opcionales, de corta o larga
distancia, etcétera.

- Para estudios estratégicos se debería definir el área de estudio de forma que
la mayoría de los viajes tenga su origen y destino dentro de ella. Sin embargo,
esto puede no ser posible en el análisis de problemas de transporte en
pequeñas áreas urbanas donde la mayoría de los viajes de interés atraviesan
el área e interesa considerar la posibilidad de establecer una circunvalación
(by-pass).

-  Problemas similares surgen en estudios de gestión de tráfico en áreas locales,
donde los flujos de tráfico también tienen su origen o destino, o ambos,
fuera del área de interés. En estos casos es interesante saber si es posible
modelizar los cambios que experimentarían estos viajes como consecuencia
de nuevas intervenciones en la red.

- El área de estudio tendría que ser algo mayor que el área concreta de interés
y debe comprender todos los proyectos de transporte que hayan de ser
considerados. Debe permitir el cambio de rutas, cambios en el destino, etc.,
ya que interesa modelizar sus efectos en el área de estudio.

La región externa al área de estudio se divide normalmente en un cierto
número de zonas externas. En algunos casos puede ser suficiente considerar
cada zona exterior como representante de una parte del “resto del mundo” en
una dirección particular. Las fronteras de estas diferentes partes del “resto del
mundo” podrían representar áreas naturales conectadas mediante arcos de
transporte por los que circulen flujos que alimentan el área de estudio. En otros
casos, puede ser ventajoso considerar zonas externas de tamaño creciente con la distancia al área del análisis. Esta consideración puede facilitar el análisis de
los impactos sobre diferentes tipos de viajes (corta y larga distancia).
Dicha área también debe dividirse en zonas internas más pequeñas. Su
número dependerá del compromiso entre una serie de criterios que se señalan
más adelante. Por ejemplo, para el análisis y organización de redes de gestión
de tráfico se requerirá generalmente zonas más pequeñas, representando incluso
aparcamientos de vehículos o los principales generadores/atractores de
viajes. Por otra parte, en el caso de estudios estratégicos, se necesitan diseños
zonales mucho más amplios. Por ejemplo, en estudios estratégicos de Londres
se han usado zonificaciones muy finas con unas 1.000 zonas (para 7,2 millones
de habitantes) y varios niveles de agregación de las mismas hasta 50 zonas (a
nivel de municipio). En la siguiente tabla se presentan ejemplos de los números de
zonas elegidos en diversos estudios.

````{r, echo=FALSE}
img.file <- file.path("n zonas.png")
fpar_4 <- fpar(external_img(src = img.file, height = 4, width = 5))
````

````{r, echo = F, fig.cap="Número típico de zonas en varios estudios", fig.id = "nzonas", fig.cap.style = "Image Caption", fig.topcaption=TRUE}
fpar_4
````
Fuente: Sacado de @Ortúzar2008

Las zonas se representan en los modelos de ordenador, como si todos sus
atributos y propiedades estuvieran concentrados en un único punto denominado
centroide de zona. Este punto se puede considerar flotando en el espacio y no en una localización física sobre un mapa. Los centroides se conectan a la
red mediante los conectores de centroide que representan los costes medios
(distancia, tiempo) para incorporarse al sistema de transportes modelizado que
tienen los viajes con origen o destino en esa zona. Casi tan importante como
el coste asociado a cada conector es el nodo de la red al que se conecta. Estos
nodos deben estar próximos a los puntos naturales de acceso/salida de la zona.
El papel de los centroides y conectores en la modelización debe contribuir a la
definición de los límites de zonas.
A continuación se incluye un sencillo listado de criterios de zonificación
que han sido recopilados a partir de la experiencia adquirida en varios estudios:

a) El tamaño de las zonas debe ser tal que el error de agregación causado por la hipótesis de que todas las actividades se concentran en el centroide, no
sea muy grande. Puede ser conveniente comenzar con un sistema con zonas
muy pequeñas, ya que éstas pueden agregarse de varias formas dependiendo
de la naturaleza de los proyectos que vayan a ser evaluados.

b) El sistema de zonificación debe ser compatible con otras divisiones administrativas,
particularmente las zonas censales. Este criterio es probablemente
el fundamental y el resto sólo ha de seguirse si no conduce a inconsistencias
con el censo.

c) Es necesario que las zonas sean lo más homogéneas posibles en su composición
de usos del suelo y/o población. Las secciones censales con claras diferencias
al respecto (p. ej., sectores residenciales con niveles de ingreso
diferentes) no deben agregarse, ni aunque sean pequeñas.

d) Es importante que los límites de zonas sean compatibles con los cordones y
las líneas-pantalla, así como con los límites de zonificaciones preexistentes.
Se ha demostrado en la práctica que se debe evitar el uso de vías o calles
principales como límites de zonas, ya que incrementa considerablemente
la dificultad de asignar viajes a zonas, cuando éstos se originan o acaban
en la frontera entre las mismas.

e) La forma de las zonas debe permitir una identificación sencilla de los conectores
de centroides. Esto es particularmente importante para la estimación
sucesiva de características intrazonales. Una zona debe representar
el área natural de cobertura de las redes de transporte y su(s) conector(es)
debe(n) ser identificado(s) de forma que representen los costes principales
de acceso a la red.

f) Las zonas no tienen porqué ser de tamaño similar. Si acaso pueden ser de
dimensiones semejantes en unidades de tiempo de viaje, lo que implica la
generación de zonas más pequeñas en áreas más congestionadas.

Algunas veces puede ser ventajoso desarrollar un sistema de zonas jerárquico,
como el empleado en los Estudios de Transporte de Londres (LTS), en
el que las subzonas se agregan en zonas mayores, que a su vez se agregan
en distritos, municipios y finalmente sectores. Esto facilita un análisis al nivel
de detalle adecuado para diferentes tipos de decisiones. Los sistemas de zonificación
jerárquica pueden plantearse con un esquema de numeración zonal
adecuado, en el que el primer dígito indica el sector, el segundo el municipio,
el tercero el distrito y así sucesivamente.

### 2.6.2 Representación de Redes

La red de transporte trata de representar la parte de la oferta dentro del proceso
de modelización, es decir, lo que el sistema de transporte ofrece para satisfacer
las necesidades de desplazamiento de los viajeros en el área de estudio. La
descripción de una red de transporte en un modelo de ordenador puede realizarse
con diferentes niveles de detalle y requiere simplificar su estructura,
sus propiedades o atributos y la relación entre dichos atributos y los flujos de tráfico @Ortúzar2008.

A. Detalles de la red

La red de transporte puede representarse con diferentes niveles de agregación dentro de un modelo. En un extremo están los modelos sin ningún arco que se
basan en representaciones continuas de la oferta de transporte @Smeed1968.
Con estos modelos se puede obtener, por ejemplo, una ecuación continua de
la capacidad media de tráfico por unidad de área en vez de por elementos
discretos o arcos. En un nivel de desagregación ligeramente mayor, se puede
considerar una calle o vía individual, pero suponiendo características como la
curva flujo-velocidad tomada de un área mucho más amplia; ver, por ejemplo,
Wardrop @Wardrop1968.
La práctica normal, sin embargo, es modelizar la red como un grafo dirigido u orientado, es decir un sistema de nodos y arcos conectados @Larson1981. La mayor parte de los nodos representa intersecciones, mientras que los arcos representan tramos de calles o vías homogéneas entre intersecciones. Los arcos se caracterizan por varios atributos como, por ejemplo, longitud, velocidad, número de carriles, etc., y son habitualmente unidireccionales.
Incluso si se especifica durante la entrada de datos un único arco de doble
dirección, por simplicidad, éste se convierte luego, internamente en dos arcos
unidireccionales. Un subconjunto de nodos se asocia a los centroides de zonas y
un subconjunto de los arcos a los conectores de los centroides. 
Un problema con este enfoque es que la conectividad de un nodo a cada arco
que llega a él no tiene coste alguno, pero en la práctica algunos movimientos
de giro en intersecciones pueden ser más difíciles de realizar que otros, incluso
pueden estar prohibidos. Para representar mejor estas características de la red
real, es posible penalizar y/o prohibir movimientos de giro. Esto puede hacerse
manualmente desagregando la intersección y asignando arcos separados (llamados
a veces arcos ficticios) a cada movimiento de giro y asociando costes diferente
a cada uno. Algunos programas comerciales son capaces de llevar a cabo
esta desagregación de forma semiautomática, siguiendo instrucciones simples
proporcionadas por el usuario sobre los movimientos penalizados o prohibidos.
El nivel de desagregación puede incrementarse posteriormente si se utilizan
modelos detallados de simulación de tráfico (nivel micro de planificación).
En estos casos se utilizan arcos adicionales en intersecciones complejas para
tener en cuenta el funcionamiento de los carriles reservados, señales de ceda
el paso, etcétera.
Las redes son a veces subconjuntos de sistemas más amplios y por tanto
pueden ser delimitadas por un cordón que defina los accesos, o puntos del
cordón, donde la red de interés está conectada con el resto del mundo. Estos
puntos se denominan en ocasiones “puertas” (gateways) y se pueden utilizar
arcos ficticios para conectarlos con las zonas exteriores.
Una decisión fundamental en la preparación de una red es determinar los
niveles de jerarquía viaria que han de incluirse. Si se incluyen más calles, mejor
será la representación de la realidad, pero de nuevo aparecerá el problema de los
costes del estudio frente al realismo, lo cual puede conducir al modelizador a
prescindir de algunos arcos. Además, no tiene mucho sentido incluir un número
elevado de vías en la red para después realizar hipótesis más generales sobre
giros y demoras en las intersecciones. Tampoco es muy razonable utilizar una
red muy detallada junto con un sistema de zonificación menos preciso, ya que
los errores de agregación espacial (en términos de conexión de centroides a
la red) reducen el valor de todo el proceso. Esto es especialmente importante *en el caso de redes de transporte público* Lo que más importa es que la elección de rutas y flujos sea lo más realista posible dentro de las limitaciones del estudio. Jansen y Bovy @Jansen1982 investigaron la influencia de la definición y detalle de las redes sobre el realismo de la asignación de flujos en la red. La principal conclusión de su estudio es que se obtienen errores más grandes en los niveles jerárquicos más bajos de la red viaria. Por tanto se debe incluir en la red al
menos un nivel por debajo de los arcos de interés. Por ejemplo, en un estudio
de vías de tipo A (carreteras nacionales), se ha de incluir las vías de tipo
B (carreteras secundarias).
En el caso de redes de transporte público se requiere un nivel de detalle
adicional. El modelizador debe especificar la estructura de redes que corresponda
a los servicios de transporte público ofrecidos. Éstos se codifican como
una secuencia de nodos sobre los cuales transita el servicio (autobús, ferrocarril),
en donde normalmente cada nodo representa una parada o estación. Las
intersecciones sin paradas de autobús pueden, por tanto, excluirse de las redes
de transporte público. Además se necesita añadir a las redes dos tipos de arcos
adicionales: los arcos a pie, que representan la o las partes del viaje realizadas
andando, y los arcos que modelizan los costes adicionales asociados con el
trasbordo de uno a otro servicio.

B. Propiedades de los arcos

El nivel de detalle asociado a los atributos de los arcos depende del nivel general
de resolución de la red y del tipo de modelo utilizado. En el nivel mínimo de
análisis se requieren los siguientes datos referentes al arco:

- Longitud.

- Velocidad de recorrido, bien como velocidad a flujo libre o bien como un
valor observado para una determinada intensidad de tráfico.

- Capacidad del arco, habitualmente en unidades equivalentes de vehículos
de pasajeros (PCU) por hora.

Además se debe asociar una relación coste-flujo a cada arco, como se señala
más adelante. En algunos casos se emplean modelos más elaborados para
representar las demoras al flujo de tráfico, pero éstos requieren información
adicional sobre los arcos, por ejemplo:

- Tipo de vía (autovía, vía principal, calle local).

- Anchura de calzada, número de carriles o ambos.

- Indicaciones sobre la presencia o ausencia de carriles bus o prohibiciones para el uso de determinados vehículos (p. ej., camiones).

- Giros prohibidos o giros que se realizan sólo cuando existe espacio disponible en el tráfico opuesto.

- Tipo de intersección y detalles de la misma, incluyendo regulación semafórica.

- Capacidad de almacenamiento de colas y su existencia al comienzo de una
determinada fase semafórica y/o período de modelización.

Estudios holandeses han demostrado que el tiempo y la distancia (ponderados)
explican solamente el 70% de las rutas realmente utilizadas. La categoría de
la vía (autopista, carretera tipo A, tipo B), la calidad escénica, los semáforos
y la capacidad contribuyen a explicar la utilización de rutas adicionales. A
medida que progrese la comprensión de la influencia de estos atributos en la
elección de ruta, se podrán desarrollar modelos de asignación más realistas.
La contrapartida a este avance será la necesidad de incluir otras características
de las vías, tales como su calidad escénica, número de intersecciones de cada
tipo, etcétera.

C. Coste de las redes

La mayor parte de las técnicas actuales de asignación suponen que, en la elección
de ruta, los conductores tratan de minimizar una combinación lineal de
tiempo y distancia, denominada a veces coste generalizado. Esta hipótesis es
simplista, ya que existen muchas diferencias no sólo en la percepción del tiempo,
sino también en su importancia relativa comparada con otras características
de las rutas. Sin embargo, la gran mayoría de los modelos de redes utilizados
hoy en día trabajan únicamente con distancia y tiempo de viaje.
Deben distinguirse dos casos cuando se modeliza el tiempo o el coste de viaje
como una función del flujo existente. El primero es cuando se puede suponer
que las demoras en un arco dependen sólo del flujo del arco; éste es el caso típico
de arcos de gran longitud alejados de intersecciones, y por tanto, es el empleado
en la mayor parte de los modelos de asignación interurbanos hasta hoy. El segundo
caso se puede encontrar en áreas urbanas, en las que el tiempo o coste de viaje en un arco depende de forma importante del flujo en otros arcos, por ejemplo,
para tráfico no prioritario en una intersección de tipo ceda el paso o glorieta.

La introducción de formulaciones muy generales para la relación flujo-demora
no es complicada hasta llegar al siguiente paso: el equilibrio entre la
oferta y la demanda. Aquí, el tratamiento matemático del primer caso (denominado
corrientemente como el caso de función de costes separable) es más simple
que el del segundo. Sin embargo existen actualmente técnicas matemáticas
adecuadas para resolver el equilibrio de la demanda y la oferta en modelos en
los que el coste o tiempo de viaje en arcos depende del flujo en varios arcos; es
decir, en los casos en los que el efecto de cada flujo no puede ser separado. 

## 2.7 Asignación de Transporte Público

### 2.7.1 Características

A. La Oferta

La red de servicios de transporte público es diferente a la de transporte privado,
en tanto que incluye, como arcos, secciones de los servicios de los autobuses o trenes que transitan entre dos paradas o estaciones. En el transporte público,
el concepto de capacidad del arco se asocia a la capacidad de cada unidad
(autobús o tren) y a su correspondiente frecuencia @Ortúzar2008. Además, el tiempo de viaje
tiene una componente pura a bordo del medio más otra relativa al tiempo de
espera en las paradas y otra más debida al tiempo andando hacia y desde la
parada para llegar al punto de destino. Muchas secciones del transporte público
utilizan los arcos viales dado que los servicios de autobús y algunos tranvías
(LRT) recorren las calles de una ciudad. Otras secciones o servicios utilizan
en cambio arcos completamente diferentes, por ejemplo, carriles exclusivos
para buses, trazados reservados a los trenes, etc. Generalmente la naturaleza
de estos arcos genera una red más compleja.

B. Los Pasajeros

En el transporte público la elección del recorrido se refiere a la elección de los
pasajeros y no de los vehículos. Los pasajeros pueden caminar hasta la parada,
hacer intercambio entre dos servicios y también efectuar parte del recorrido
en coche y luego tomar el transporte público. Ello comporta la necesidad de
construir y precisar los arcos peatonales y de transbordo entre diferentes servicios,
entre diferentes modos de transporte público (autobús, tren) y entre infraestructuras
de transporte público y privado (p. ej., “Park and Ride”).

C. Los costes monetarios

En las redes de transporte individual es normal suponer que los costes monetarios
estén asociados directamente con el consumo de carburante, que es a su vez,
proporcional a la distancia de viaje. Éstas son obviamente aproximaciones y
son generalmente aceptadas porque los conductores no perciben estos costes de
modo tan directo como un pasajero de transporte público percibe su tarifa.
En años recientes ha aumentado la variedad de estructuras tarifarias de
transporte público; existen hoy tarifas variables con la distancia, tarifa única
independiente de la distancia del viaje, tarifas zonales para una o más zonas
geográficas particulares, billetes combinados que incluyen transbordos (válido
para dos o más servicios), tarifas limitadas en el tiempo (p. ej., tarifas válidas
para cualquier número de embarques en una hora), diarias, semanales u
otros “bonos o pases” para un servicio dado o que cubren una o más zonas y
modos.

Esta amplia variedad tarifaria dificulta el trato de tarifas en los modelos
de elección de recorrido y asignación, en cuanto a que los costes monetarios
no dependen directamente de la distancia y sí generalmente de la localización
del origen y del destino y del recorrido seleccionado.

D. Costo Generalizado

En el caso de una asignación de demanda al transporte público el coste generalizado
de viaje puede ser definido como sigue:

$C_{ij} = a_1t_{ij}^v + a_2t_{ij}^w + a_3t_{ij}^t + a_4t_{ij}^n + a_1\delta^n + a_5F_{ij}$
\newline
$Donde:$
\newline
$t_{ij}^v\ es\ el\ tiempo\ de\ viaje\ a\ bordo\ del\ modo\ para\ ir\ de\ i\ a\ j;$
\newline
$t_{ij}w^\ es\ el\ tiempo\ andando\ para\ llegar\ o\ ir\ desde\ la\ parada\ (estación);$
\newline
$t_{ij}t^\ es\ el\ tiempo\ de\ espera\ en\ la\ parada;$
\newline
$t_{ij}n^\ es\ el\ tiempo\ de\ transbordo;$
\newline
$δ^n\ es\ una\ penalidad\ intrínseca\ o\ resistencia\ al\ trasbordo,\ medida\ en\ unidad\ de\ tiempo\ (usualmente\ de\ 2\ a\ 5\ minutos);$
\newline
$F_{ij}\ es\ la\ tarifa\ pagada\ para\ desplazarse\ entre\ i\ y\ j;$
\newline
$De\ a_1\ a\ a_5\ son\ coeficientes\ asociados\ a\ los\ elementos\ de\ coste\ respectivos$

Usualmente a $a_1$ o $a_5$ suele otorgársele el valor 1 según se deseen medir los
costes generalizados de transporte en unidad de tiempo o coste respectivamente.
También es habitual encontrar que $a_2$, $a_3$, y $a_4$ sean dos o tres veces el valor de
$a_1$, es decir los viajeros perciben el tiempo de espera o caminando dos o tres
veces más que a bordo del medio.

En términos de modelización, el software debería ser capaz de tratar todas
estas variables y producir una buena estimación de cada uno de estos componentes
de tiempo (a bordo, peatonal, de espera, de intercambio) a menos que
sus valores no sean proporcionados externamente. El tiempo de viaje a bordo
del modo depende de la velocidad alcanzable y del número y de la duración
de las paradas en el recorrido; el tiempo utilizado caminando depende de la
proximidad de la parada más cercana (más atractiva) y se suele utilizar, en algunos
casos, aproximadamente un valor medio del tiempo para la zona completa;
el tiempo de transbordo varía en función de la configuración y de la distancia
entre las paradas y las estaciones; por fin el tiempo de espera depende esencialmente de la frecuencia del servicio y de su fiabilidad. Una formulación general del tiempo de espera es:

$t^w = \frac{(h^2 + \sigma^2)}{2h}$

donde $h$ es tiempo entre dos pasos de bus (intervalo) previstos por la programación
del servicio y σ es su desviación estándar (cuanto menos regular es
el servicio, mayor es el tiempo de espera). Esta formulación supone que los
pasajeros llegan aleatoriamente a la parada y que los autobuses tienen capacidad
ilimitada, de modo que todos pueden subirse a bordo. El problema relativo a
la "congestión del autobús" es difícil de resolver, pero si los algoritmos utilizados
no lo consideran es probable que las cargas producidas no sean reales en
términos de capacidad real del servicio (véase @DeCea1989). Si
el servicio es perfectamente regular, es decir si $\sigma = 0$, entonces el tiempo previsto
de espera es la mitad del intervalo entre el paso de dos autobuses consecutivos.
Es sabido, sin embargo, que si la frecuencia del servicio es baja, los
pasajeros tienden a llegar justo pocos minutos antes de la siguiente salida, así
que el límite superior del tiempo de espera puede ser establecido entre 5 y
10 minutos; obviamente los pasajeros llegarán tanto más cerca del horario de
salida programado cuanto más fiable resulte el servicio.

E. Líneas Comunes

Éste es probablemente uno de los problemas más difíciles y típicos en la asignación
al transporte público. El problema surge cuando, al menos para algunos
pares O/D, hay secciones en recorrido donde transita paralelamente más de un
servicio de los ofertados, de forma que los pasajeros pueden elegir aquél que se
acomoda mejor a sus exigencias. Para dichos pasajeros esta elección no es trivial
(habría sido preferible que el usuario hubiese sabido que un servicio expreso
iba a llegar tres minutos después del más lento que ha tomado) ni simple desde
el punto de vista modelístico. En efecto, mientras en el transporte privado normalmente
un conductor elige un recorrido individual entre el conjunto de todos
los recorridos posibles, en el caso del transporte público, los usuarios pueden
elegir un conjunto de itinerarios prefijados, de forma que cuando una línea
de bus susceptible de ser utilizada llega primero a la parada, va a determinar
cuáles de los itinerarios factibles realmente van a ser escogidos. La elección
es por tanto más compleja y necesita un trato más detallado.

No es posible presentar aquí una discusión completa de los algoritmos más
apropiados para la asignación al transporte público. Se describirán, por tanto,
los principales métodos o aproximaciones a la modelización, primeramente la
elección del recorrido y posteriormente la asignación. Estos enfoques difieren
en el modo en que se tratan algunas de las problemáticas citadas anteriormente,
en particular las que conciernen a la superposición de las líneas y a las
de la elección de los métodos de asignación: todo o nada, estocásticos o con
restricción de capacidad.

### 2.7.2 Modelos de elección de ruta

Antes de discutir los problemas de la elección del recorrido en presencia de
líneas comunes es útil definir con mayor detalle algunos términos como recorrido
o ruta, línea y sección.
Una línea de transporte público, o sencillamente una línea, es una flota de
vehículos que transitan entre dos puntos (terminales) de una red, generalmente
con las mismas características de dimensión, capacidad, velocidad, etc. La
parada de los vehículos en cada nodo a lo largo de sus recorridos permite a los
usuarios subir o bajar de los autobuses (o trenes, etc.). Por tanto cada línea se
define por las características del vehículo, la secuencia de los nodos que ella
sirve y la frecuencia de los servicios ofrecidos.
Una sección de línea es una porción cualquiera de una línea de transporte
colectivo entre dos nodos, no necesariamente consecutivos.
Una ruta o recorrido de transporte público es cualquier itinerario que un
usuario puede seguir sobre la red del transporte colectivo para desplazarse
entre dos nodos. La porción de recorrido entre dos nodos de intercambio consecutivo
se denomina sección de ruta, a la que se asocian una serie de líneas
atractivas o comunes.
Una estrategia es una serie de reglas que permiten al viajero alcanzar el
mismo destino.

Durante muchos años la elección de la ruta que minimiza el tiempo de viaje
ha constituido la aproximación convencional al problema. Sin embargo, una
buena estrategia flexible produce tiempos de viaje esperados más breves con
respecto a la aproximación convencional; en efecto, dicha estrategia flexible es
más realista y permite al usuario obtener ventaja de la variabilidad del tiempo
de espera con respecto a una elección más oportuna de un buen servicio pero
con frecuencias más bajas @Spiess1989.

Para cada nodo se puede definir también una serie de líneas atractivas que
serían parte de una buena estrategia para alcanzar un determinado destino j.
Dada una estrategia, un desplazamiento real se desarrolla en base al siguiente
mecanismo:

1. Situar al viajero en el nodo $i$ de origen.
2. Abordar el primer bus que llega y que pertenece a la serie de líneas atractivas
para los pasajeros de $i$.
3. Descender del bus en un nodo predeterminado.
4. Si todavía no es su destino, se emplaza $i$ en el nodo correspondiente y se
vuelve al paso 2; en otro caso, el viaje ha finalizado.

Obsérvese que aunque este mecanismo tenga el nodo de destino bien definido,
el origen no forma parte de la estrategia. Una estrategia es el conjunto
de reglas que permite a los usuarios alcanzar su destino partiendo de un nodo
cualquiera de la red. Esta exposición se explica por las siguientes notaciones
adicionales:

$Sjk = conjunto\ de\ secciones\ de\ línea\ que\ conectan\ directamente\ los\ nodos\ j\ y\ k;$
\newline
$L_j^+ = conjunto\ de\ secciones\ de\ línea\ en\ salida\ del\ nodo\ j;$
  \newline
  $v_s = flujo\ sobre\ la\ sección\ de\ línea\ s;$
  \newline
  $t_s = tiempo\ de\ viaje\ a\ bordo\ del\ vehículo\ sobre\ la\ sección\ de\ línea\ s;$
  \newline
  $f_s = frecuencia\ asociada\ a\ la\ sección\ de\ línea\ s;$
  \newline
  $g_j = número\ de\ viajes\ hacia\ el\ destino\ j;$
  \newline
  $V_{jk} = flujo\ total\ sobre\ la\ sección\ de\ ruta\ jk.$

Entonces, se puede identificar el conjunto de líneas atractivas que provienen
del nodo $j$ utilizando la variable $X_s$; donde $X_s$ es igual a 1 si la sección $s$ de la línea, perteneciente al conjunto de secciones que van de $j$ a $k$, es atractiva, en otro
caso es igual a cero. Luego para un par de nodos $j,k$ dados, los valores asociados
$X_s\ (s\ \epsilon\ S_{jk})$ definen el conjunto óptimo o atractivo de las líneas hacia $k$.

### 2.7.3 Asignación de viajes

Una vez identificado el mejor conjunto de segmentos de línea que unen los
orígenes y los destinos es necesario realizar la asignación de los viajes a estas
líneas. La mayor parte de los programas tratan de conseguir una distribución
razonable y realista de los viajes entre los recorridos factibles. En las aproximaciones
convencionales, en las que las problemáticas de las líneas comunes no se
afrontan explícitamente, resulta que la amplia distribución de viajes se genera
teniendo en cuenta una serie de criterios; por ejemplo: distinguir explícitamente
los diferentes puntos de acceso (paradas, estaciones) para cada zona y construir
para cada punto de acceso, y no simplemente para los centroides, los árboles
de mínimo coste hacia todos los destinos. De este modo se identifican varios
recorridos alternativos, uno por cada punto de acceso diferente. Los usuarios
pueden asignarse a estos recorridos utilizando una función multinominal logit
en la que los costes son los costes de los arcos entre los orígenes y los destinos
para cada ruta o recorrido.

Spiess y Florian @Spiess1989 realizan la fase de asignación siguiendo estrategias
óptimas identificadas. La asignación, por tanto, se consigue asignando a cada
arco el porcentaje de volumen acumulado aguas arriba del nodo y que corresponde
a la frecuencia ofertada por el arco. De Cea y Fernández @DeCea1989, siguen
una aproximación parecida pero en dos pasos:

1. En el primero, una vez que ha sido localizada la serie de líneas comunes
para todos los pares $(i,j)$ se construye una nueva red en base a los nodos y
las secciones de ruta. Es de destacar que las secciones de ruta contienen
solamente las líneas que minimizan el tiempo total de viaje esperado en
la sección; ellas tienen asociado un tiempo de viaje $(t_r)$ y una frecuencia
$(f_r)$ correspondiente a la suma de las frecuencias atractivas (las de las líneas
comunes). Con estos dos elementos se puede obtener un coste de viaje
compuesto a lo largo de esta sección de ruta, y por lo tanto para encontrar
la mejor ruta puede utilizarse un algoritmo apropiado y eficiente de construcción
de árboles de mínimo coste. Cargando estos árboles resulta un conjunto de flujos de sección de ruta $(v_r)$.

2. A continuación se descomponen los flujos de la sección de ruta en las secciones
de línea que la conforman: 

$v_s = \frac{f_sv_r}{f_r}$

Hasta aquí no se ha tratado el problema referente al empleo de sistemas
particulares de tarificación. Si el sistema de tarificación es proporcional a la
longitud de viaje se pueden reconvertir las unidades de tiempo en unidades de costes y, a partir de aquí, añadir a dicho tiempo de viaje sobre cada arco la
tarifa. Este tipo de estructura tarifaria, en todo caso, no es muy común. Podría
asimismo introducirse un sistema tarifario único (tarifa plana o flat fare) aunque
es preciso indicar que el tratamiento de esquemas más complejos desde
el punto de vista modelístico puede añadir también dificultades al diseño del
algoritmo.
En muchos casos prácticos no es posible modelizar toda la complejidad de
un sistema tarifario y por tanto, han de realizarse determinadas aproximaciones
de acuerdo a las tipologías más comunes de billetes utilizados. Por ejemplo,
en el caso de un sistema tarifario zonal la asignación se puede elaborar en
base solamente al tiempo de viaje mientras que el coste de la tarifa sólo será
añadido al final. Esta solución no tiene en cuenta a los usuarios que dispongan
de contratos especiales de transporte (bono-buses), aunque dicho sistema de
tarificación zonal puede resultar en todo caso bastante bueno en ciertas situaciones
como, por ejemplo, el acceso al centro de Londres.
Finalmente, se debe subrayar que la asignación al transporte público presenta,
generalmente, los mismos límites que los identificados para las redes de
transporte privado. Además es correcto afirmar que la asignación en situaciones
de congestión está menos desarrollada que la de situaciones sin congestión. En
el caso de redes congestionadas se presentan dos efectos: el primero concierne
a la capacidad limitada de las unidades de transporte (autobuses, trenes), lo
que provoca que algunos usuarios no puedan realizar sus estrategias óptimas,
lo cual supone en general un incremento de su tiempo de viaje; el segundo es
que hay una interacción entre transporte público y circulación privada debida
al hecho de que se utilizan las mismas calles, de forma que el consiguiente
incremento de tráfico sobre un modo influirá en el tiempo de viaje del otro.

\newpage

# CAPÍTULO 3: METODOLOGÍA

En este capítulo se define la metodología general de la presente propuesta metodológica que permitirá obtener el mayor número de zonas para el área de estudio a partir del análisis de los datos disponibles y la construcción de modelos estadísticos-espaciales. 
En el primer apartado se describirá el Diagrama Metodológico general y en el segundo subítem se describirán cada una de sus etapas.

El objetivo de esta metodología es que a partir de la información espacial detallada se pueda construir un mayor número de zonas. Esta será una iteración para cada zona de la zonificación actual (EOD 2012) que actúa en el área de estudio, para ello, se aplicarán geoprocesos, clusterización espacial y la aplicación de la Teselación de Voronoi. El enfoque de esta metodología, es ser aplicada para el periodo punta mañana (6:30 - 9:00) dado que es el periodo más exigente del día.

## 3.1 Metodología General

````{r, echo=FALSE}
img.file <- file.path("MET_GNRL.png")
fpar_5 <- fpar(external_img(src = img.file, height = 4, width = 5))
````

````{r, echo = F, fig.cap="Metodología General", fig.id = "Met", fig.cap.style = "Image Caption", fig.topcaption=TRUE}
fpar_5
````
Fuente: Elaboración Propia

La Metodología está desglosada en 3 fases conectadas, que son:

a) la adquisición de datos y post-procesamiento para alimentar el modelo,

b) Definición de modelo matemático y flujo del proceso de modelación, y

c) Entrega de resultados, que es el producto de la Propuesta Metodológica.

## 3.2 Etapas Metodológicas

### 3.2.1 Datos de Entrada

Los datos de entrada, serán los que se necesiten tanto para la construcción de la nueva zonificación como para validar los resultados del modelo.

- Población: Mediante la información a nivel de zona Censal, se obtendrá la densidad poblacional para el área de estudio.

$\rho_{zs} = Población_{zs}/Área_{zs}$

- Localización de Paradas y Estaciones de Metro: Se georreferenciará la información de paradas de bus disponibles en los planes operacionales que son provistos por *DTPM*, las que serán empalmadas con la georreferencia de las estaciones de *metro de santiago*.

- Movilidad: La *Universidad de Chile* a través de su software Adatrap ha dispuesto de manera pública los viajes que realizan los usuarios de *RED Movilidad* @viajes, proceso que es detallado en @Gschwender2016. A partir de lo anterior, se pueden obtener los distintos tiempos de viaje, tiempo de espera y tiempo de transbordos, para el caso del tiempo de acceso y tiempo de egreso, estos serán estimados según la caminata del inicio/fin de viaje hacia los centroides de zona.   

- Zonificación: Contamos con una Zonificación inicial que en este caso será la EOD 2012.Sin embargo, esta cobertura presenta problemas topológicos dado que presentan hoyos, en algunos casos son razonables porque corresponden a hitos geográficos como rotondas que no dejan de complejizar por la existencia de paradas y su asociación a zonas que es muy importante en el proceso; pero por otro lado, hay zonas que por edición están separadas unas de otras, cayendo en este vacío algunas paradas. Ejemplo de esto es:

````{r, echo = F, message = F, warnings = F, tab.cap='Paradas a Reposicionar', tab.id='Repos'}
 filter(start_pts, is.na(Zona)) %>%
    as_tibble() 
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warnings = F, fig.cap='Paradas a Reposicionar', fig.id='Repos', fig.topcaption=TRUE}
tm_shape(zoi) + 
    tm_grid(col = "white", lwd = 2, labels.size = .5, n.x = 4) +
    tm_polygons() +
    tm_shape(filter(start_pts, is.na(Zona))) +
    tm_dots(size = .1) +
    tm_layout(bg.color = "lightblue", main.title = "Paradas a Reposicionar", main.title.position = "center", main.title.size = 1.1) +
    tm_compass(position = c("right", "bottom"), type = "arrow", size = 2) +
    tm_scale_bar(position = c("right", "bottom"))
````
Fuente: Elaboración Propia

Estos 6 casos puntuales fueron sometidos a edición manual para que las paradas cayeran en la zona más próxima. 

- Vialidad: Se utiliza la cobertura de vialidad generada por INE 2017, esta es utilizada para obtener los tiempos de caminata de acceso y egreso a los centroides mediante el cálculo de camino más corto usando algoritmo dijkstra, para ello, se eliminan ejes que correspondan a Carretera o Camino Privado. Posterior a ello, se determina cual es el camino más corto desde cada para de inicio de viaje y fin de viaje a cada centroide de zona.

$Sea:$\newline 
$Z_i = Zona\ del\ Área\ de\ estudio,\ donde\ i \in \mathbb{Z}:1\ a\ 483$ \newline
$P_{i,j} = Localización\ de\ parada\ o\ estación\ de\ metro\ j\ / P_{i,j} \cap Z_i\ \forall i$ \newline
$C_i = Matriz\ de\ costo\ en \ distancia\ de\ la\ red\ vial\ / red\ vial\ \cap Z_i\ \forall i$
$\Longrightarrow \ C.C(P_{i,j}, Cent_i) = min\ \overrightarrow{dist}(P_{i,j}, Cent_i)\forall \ i$ \newline
$C.C = Camino\ más\ corto$ \newline
$Cent_i = Centroide\ en\ zona\ i$ \newline

Para ello, se utilizó la librería sfnetworks en R @sfnet, la que permite calcular las distancias más cortas en un grafo con datos geográficos, en este caso, el grafo construido sobre la vialidad no fue aplicado en direccionalidad dado que solo nos interesan las caminatas, que para los tiempos se consideró que en promedio es de 48 m/min.

Por ejemplo, el camino más corto en la zona 375 desde la parada "PD26" hacia el centroide es:

````{r, echo = F, message = F, warning = F, fig.cap='Ruta Más Corta', fig.id='Dijkstra', fig.topcaption=TRUE}
tm_shape(filter(zoi, Zona == 375)) + 
    tm_grid(col = "white", lwd = 2, labels.size = .5) +
    tm_polygons() +
    tm_shape(filter(st_as_sf(zones_vial), Zona == 375)) +
    tm_lines() +
    tm_shape(filter(ctd, Zona == 375)) +
    tm_dots(col = "red", size = 0.5) +
    tm_shape(filter(start_pts, Zona == 375)[1,]) +
    tm_dots(col = "blue", size = 0.5) +
    tm_shape(filter(zones_vial, Zona == 375) %>%
                 convert(to_spatial_shortest_paths,
                         from = filter(start_pts, Zona == 375)[1,],
                         to = filter(ctd, Zona == 375)) %>%
                 st_as_sf()) +
    tm_lines(col = "purple", lwd = 4) +
    tm_layout(bg.color = "lightblue", main.title = "Ruta más Corta", main.title.position = "center", main.title.size = 1.1) +
    tm_compass(position = c("left", "top"), type = "arrow", size = 2) +
    tm_scale_bar(position = c("left", "bottom"))
````
Fuente: Elaboración Propia

Los datos de entrada necesitan de un procesamiento, en el caso de las paradas se escogen 3 planes operacionales, de modo de minimizar la cantidad de paradas que no sean encontradas en los datos de movilidad, la fecha de estos planes son: 1 de marzo, 1 de abril y 23 de junio de 2019, de estos se obtienen los únicos del código de parada tanto de usuario como la codificación interna del DTPM, a esto se adicionan las columnas x e y que contienen coordenadas en proyección UTM, por lo que pueden ser espacializadas. Mediante este proceso solo no fueron encontradas las paradas de codificación usuario "PF1126" y "PD1614", las que fueron agregadas posteriormente mediante una búsqueda directa. Estas posteriomente se unifican al diccionario de estaciones de metro, que fueron geolocalizadas por observación en Google Earth.

Los datos de movilidad son obtenidos a partir del procesamiento de las tarjetas bip! contienen la codificación interna del DTPM tanto para las paradas como para los recorridos, por eso es que en la obtención de las paradas se necesitaban las dos codificaciones, en el caso de los recorridos se crea diccionario para una mejor identificación, esta información de diccionario puede ser confeccionada a partir del archivo geográfico de rutas del plan operacional, el cual posee columnas en su tabla de atributos con ese fin, el que se debe complementar en función de las rutas que no encuentre mediante una inspección de su codificación.


### 3.2.2 Modelo

La definición matemática es:

Sea vector $\vec Z{i}, \ i = \{1, ..., n\}$ donde n es el número total de zonas del área de  estudio, tal que:

i) Existe vector $\vec x_{jk}, \ j = \{1, ..., m\}; \ k = \{1, ..., p\}$ donde j el par de coordenadas para cada parada y k es un vector de los atributos $| \ \exists \ cluster_{l} \  \forall z_i$

ii) Centroide $\forall \ cluster_{l}$

iii) $V(p_l) = \{p | \in S; d(p, p_l), t \neq l\}$

```{r, echo=FALSE}
img.file <- file.path("OVD.png")
fpar_iii <- fpar(external_img(src = img.file, height = 4, width = 5))
````

````{r, echo = F, fig.cap="Diagrama de Voronoi Ordinario", fig.id = "Vor", fig.cap.style = "Image Caption", fig.topcaption=TRUE}
fpar_iii
````
Fuente: Sacado de @Boots1999

iv) $\Re_d \cap Z_i$

El modelo será aplicado para cada polígono de la zonificación base del área de estudio y el tratamiento de los datos mencionado en el ítem anterior serán del tipo puntual. 
Con ello, se construirá un método de clusterización jerárquica con tratamiento de datos espaciales, primero generamos geoproceso que filtre la cantidad de puntos en cada zona y posteriormente aplicamos el método para todos aquellos polígonos en los que contengan mayor a dos paradas de modo que se pueda calcular los cluster, la clusterización lo haremos según lo que propone @Chavent2018, quien integra en el método de clusterización restricciones espaciales para crear dos matrices de disimilaridades. Una con atributos y otra con las localizaciones, que en nuestro caso son las paradas y estaciones de metro. Para poder aplicar la restricción espacial es necesario un parámetro de mezcla ($\alpha$) de las matrices de disimilaridades, del cual calcularemos el óptimo. 

Adicionalmente, vamos a estimar automáticamente el número óptimo de clusters por cada zona, para ello, utilizaremos el método *"Gap Statistic"* que podemos encontrar el detalle en @mohajer2011comparison.

Para cada cluster se calculará envolvente para que ninguna localización quede fuera del cluster y posteriormente su centroide. Con ello, podemos ocupar la teselación de Voronoi, que produce polígonos infintos y finalmente aplicamos un geoproceso que corte espacialmente estos polígonos de voronoi según los polígonos de la zonificación inicial, obteniendo así los nuevos polígonos que serán ensamblados mediante geoproceso con los polígonos que no fueron modificados.   

El modelo más típico para clusterización es el k-medias, sin embargo, se escoge que sea el método jerárquico, dado que el k-media utiliza una búsqueda aleatoria y a nosotros nos interesa la replicabilidad.

### 3.2.3 Salida

Como resultado del procedimiento anteriormente mencionado se obtiene Nueva zonificación que, permite obtener Nueva Matriz de Origen-Destino:

$\vec Z_{ij}$

A la que se puede obtener el porcentaje de viajes intrazonales ($\vec Z_{i=j}$) que fueron recuperados, y los nuevos tiempos de acceso y egreso por los nuevos centroides de zonas.

\newpage

# CAPÍTULO 4: APLICACIÓN DEL MODELO Y ANÁLISIS DE RESULTADOS

El área de estudio corresponde al eje central de la región metropolitana, como se detalla en la siguiente figura:

`````{r, echo = F, message = F, warning = F, fig.cap='Área de Estudio', fig.id='AEst', fig.topcaption=TRUE}
tm_shape(zones) +
    tm_grid(col = "white", lwd = 2, labels.size = .5, n.x = 5) +
    tm_polygons(col = "gray") +
    tm_shape(nngeo::st_remove_holes(st_union(zoi))) +
    tm_polygons(col = "red", border.col = "black", border.alpha = 1, alpha = .5) +
    tm_layout(bg.color = "lightblue", main.title = "Área de Estudio", main.title.position = "center", main.title.size = 1.1) +
    tm_compass(position = c("right", "top"), type = "rose", size = 3) +
    tm_scale_bar(position = c("right", "bottom")) 
````
Fuente: Elaboración Propia

Esto corresponde a 483 zonas de un total de 866, es decir, un 56% de las zonas serán las que estarán sujetas al modelo.

Por los datos provistos en la base de datos de viajes a partir de las validaciones de la tarjeta inteligente (bip!) para abril de 2019, mediante el uso de consultas SQL, proceso de limpieza, imputación de datos, espacialización y geoprocesos se puede obtener la trayectoria de los viajes producidos al interior del área de estudio junto con los datos característicos de la movilidad.

Es decir, con la consulta SQL se obtienen los siguientes atributos:

- Validaciones Promedio por día Laboral
- Parada de inicio de viaje (subida),
- Parada de fin de viaje (bajada),
- Paradas de subidas en etapas intermedias,
- Cantidad de Etapas Tipo de Viaje,
- Recorridos Utilizados en cada viaje,
- tiempo de viaje
- tiempo de espera 
- tiempo de caminata, y
- tiempo de transbordo

Estos datos son filtrados por el periodo Punta Mañana, según es definido por *DTPM* (6:30-8:30 hrs.), además de eliminar aquellos registros que no tengan información de la Parada de Inicio y/o la Parada de Fin de viaje, datos que representan el 0.001% del total de viajes, que es sin considerar aún la selección al interior del área de estudio, también se procede a eliminar aquellos datos incongruentes, es decir, los viajes en los cuales la parada de inicio es la misma que la parada de fin de viaje.

La definición de viajes en el sistema RED, es aquel en el cual se puede realizar hasta un máximo de 3 transbordos (4 etapas), por tanto, todos aquellos registros en los que figuran más de 4 etapas son truncados a cuatro.

Se evidencia que hay registros con columnas sin información se procede a realizar una imputación de forma de no perder viajes, la hipótesis de esta consiste en que hay una consistencia en los patrones de viajes, las decisiones de los viajeros serán racionales y por ende serán las mismas. En la práctica se contabiliza la proporción de viajes para cada parada de inicio y parada de fin de viaje con todos sus atributos completos versus aquellos que no posean todos sus atributos, donde estos últimos tomarán los mismos atributos de los viajes completos, evitando más pérdida de información, la información que fue imputada corresponde al 3.3% de los viajes. 

Como tanto, el nombre de recorridos como de paradas de bus es obtenido con una codificación especial, se procede a realizar diccionarios de nombre de rutas y paradas a partir de los planes operacionales que están disponibles en el sitio web del DTPM, los cuales son cruzados con esta data, junto con ello, se debieron arreglar nombres de estaciones de metro dado que provenía con errores de tipeo, que sin ello, se producía una pérdida importante de viajes, entendiendo que las estaciones de metro son lugares de alta concentración de demanda. Además, a través del diccionario de paradas, los datos pueden ser espacializados dado que en este están las coordendas con proyección UTM en huso 19S. 

Con el procedimiento anteriormente mencionado, obtenemos 832,582 registros de viajes que contemplan 741,219 viajes y 10,553 paradas, al aplicar un geoproceso de selección para el área de estudio, resultan 347,023 registros connos quedamos con  399,391 viajes que corresponden a 6,703 paradas (incluidas las estaciones de metro). Es decir, el área de estudio implica una concentración de 54% de los viajes con el 64% de las paradas.

En Figura \@ref(fig:Pts) se puede visualizar las paradas en la Zona de Estudio, donde se graficó el valor de la Demanda clasificada según percentil, en el cual es posible observar un cierto grado de clusterización espacial. Esto ya nos faculta a validar la nueva zonificación en función de una clusterización.

`````{r, echo = F, message = F, warning = F, fig.cap='Paradas', fig.id='Pts', fig.topcaption=TRUE}
tm_shape(nngeo::st_remove_holes(st_union(zoi))) +
    tm_grid(col = "white", lwd = 2, labels.size = .5, n.x = 4) +
    tm_polygons(col = "red", border.col = "black", border.alpha = 1) +
    tm_layout(bg.color = "lightblue", 
              main.title = "Paradas y Estaciones", 
              main.title.position = "center", main.title.size = 1.1,
              legend.outside = TRUE) +
    tm_shape(st_filter(stops_trips, zoi, .predicate = st_within)) + 
  tm_dots(col = "Demanda", style = "quantile", palette = "viridis") +
    tm_compass(position = c("left", "top"), type = "rose", size = 3) +
    tm_scale_bar(position = c("right", "bottom")) 
````
Fuente: Elaboración Propia

Por otro lado, quisieramos verificar el comportamiento a nivel de zonificación, esto se puede construir como:

$\sum x_{jk} \ \forall Z_i$

Que es representado en la Figura \@ref(fig:Gdem)

`````{r, echo = F, message = F, warning = F, fig.cap='Generación de Demanda', fig.id='Gdem', fig.topcaption=TRUE}
DemZon <- st_join(zoi, 
                  select(stops_trips, Demanda), 
                  .predicate = st_within) %>% 
  group_by(Zona) %>% 
  summarise(Demanda = sum(Demanda))

tm_shape(DemZon) +
    tm_grid(col = "white", lwd = 2, labels.size = .5, n.x = 4) +
    tm_polygons(col = "Demanda", style = "quantile", palette = "viridis") + 
  tm_shape(zones) + 
  tm_polygons(col = "gray", alpha = .3) +
    tm_layout(bg.color = "lightblue", 
              main.title = "Generación de Demanda", 
              main.title.position = "center", 
              main.title.size = 1.1, 
              legend.outside = TRUE) +
    tm_compass(position = c("left", "top"), type = "8star", size = 3) +
    tm_scale_bar(position = c("right", "bottom")) 
````
Fuente: Elaboración Propia

Es claro, dada la estructura urbana y de generación de empleo versus la localización de vivienda es que se evidencia una clusterización zonal.

Para evaluar la efectividad del modelo se comparará el grado de ajuste en la estimación de los viajes, que como vimos en el marco teórico, tradicionalmente se utiliza un modelo estático de asignación de demanda a transporte público, el cual necesita de la matriz Origen Destino de las zonas de análisis de transporte, la red tramificada por velocidad, distancias de las rutas y una serie de parámetros que deben ser calibrados. Sin embargo, dado que los datos de movilidad que estamos usando contienen las combinaciones efectivas de rutas que los usuarios escogen para cada origen - destino (a nivel de parada), es que se opta por aplicar un modelo de Machine Learning, en @Rocio2021 muestra los distintos subcampos del transporte en los que se ha aplicado. 
Utilizando la densidad poblacional, más las variables de Costo Generalizado, que son: tiempo de viaje, tiempo de espera, tiempo de transbordo, tiempo de caminata, Tarifa. Para el caso de las variables de tiempo de acceso y tiempo de egreso, como fue mencionado anteriormente, el valor de estas últimas fue cálculado mediante el  uso de algorítmo de camino más corto (dijkstra), donde se mide la caminata hacia el centroide de zona desde la primera parada de viaje y la última parada de viaje. Por tanto, el tamaño de la zona tendrá un efecto en la modelación. 

A continuación, se realiza el análisis estadístico de las variables antes mencionadas:

En el caso de la demanda se observa un alto nivel de dispersión de los datos con la mayoría de sus datos siendo bajos, pero los valores altos, demasiado altos en comparación, esto se explica por la gran variabilidad que poseen paradas con poca demanda a diferencia de las estaciones de metro más transitadas.

````{r, echo = F, message = F, warning = F, fig.cap='Diagrama de Caja de Demanda', fig.id='DCajaDem', fig.topcaption=TRUE}
var_pts <- pivot_longer(st_drop_geometry(st_filter(stops_trips, 
                                                   zoi, 
                                                   .predicate = st_within)), 
                        !paraderosubida, 
                        names_to = "variables", 
                        values_to = "valor") %>% 
  mutate(variables = factor(variables))

filter(var_pts, variables == "Demanda", valor < 250) %>%
    ggplot(aes(variables, valor, fill = "variables")) +
    geom_boxplot(width = .3, fill = "#FFC300") +
    labs(title="Diagrama de Caja de Demanda", x = "", y = "Validaciones") +
    theme(plot.title = element_text(hjust = 0.5), axis.text.x=element_blank(), axis.ticks.x=element_blank())
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Gráfico de Demanda', fig.id='ViolinDem', fig.topcaption=TRUE}
filter(var_pts, variables == "Demanda" & valor < 250) %>%
    ggplot(aes(variables, valor, fill = "variables")) +
    geom_violin(width = .3, fill = "lightblue") +
    labs(title="Gráfico de Demanda", y = "Validaciones") +
    theme(plot.title = element_text(hjust = 0.5), 
          axis.text.x=element_blank(), 
          axis.ticks.x=element_blank())
````
Fuente: Elaboración Propia

````{r, , echo = F, message = F, warning = F, fig.cap='Distribución de Demanda', fig.id='DistrDem', fig.topcaption=TRUE}
filter(var_pts, variables == "Demanda" & valor < 250) %>%
    ggplot(aes(valor, fill = variables, colour = variables)) +
    geom_density(alpha = .5, show.legend = F, color="black", fill="lightblue") +
    labs(title="Distribución de Demanda", x = "", y = "Densidad") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Diagrama de Caja de Densidad Poblacional', fig.id='DCajaDens', fig.topcaption=TRUE}
filter(var_pts, variables == "Densidad") %>%
    ggplot(aes(variables, valor, fill = "variables")) +
    geom_boxplot(width = .3, fill = "#FFC300") +
    labs(title="Diagrama de Caja de Densidad Poblacional", x = "", y = "Densidad Poblacional") +
    theme(plot.title = element_text(hjust = 0.5), axis.text.x=element_blank(), axis.ticks.x=element_blank())
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Gráfico de Densidad Poblacional', fig.id='ViolinDens', fig.topcaption=TRUE}
filter(var_pts, variables == "Densidad") %>%
    ggplot(aes(variables, valor, fill = "variables")) +
    geom_violin(width = .3, fill = "lightblue") +
    labs(title="Gráfico de Densidad Poblacional", y = "Densidad") +
    theme(plot.title = element_text(hjust = 0.5), 
          axis.text.x=element_blank(), 
          axis.ticks.x=element_blank())
````
Fuente: Elaboración Propia

````{r, , echo = F, message = F, warning = F, fig.cap='Distribución de Densidad Poblacional', fig.id='DistrDens', fig.topcaption=TRUE}
filter(var_pts, variables == "Densidad") %>%
    ggplot(aes(valor, fill = variables, colour = variables)) +
    geom_density(alpha = .5, show.legend = F, color="black", fill="lightblue") +
    labs(title="Distribución de Densidad Poblacional", x = "", y = "Densidad") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Diagrama de Caja de Tiempos', fig.id='DCajaT', fig.topcaption=TRUE}

filter(var_pts, !variables %in% c("Demanda", "Densidad")) %>%
  ggplot(aes(variables, valor, fill = "variables")) +
  geom_boxplot(width = .3, fill = "#FFC300") +
  xlab("") +
  ylab("Tiempo") +
  labs(title="Diagrama de Caja de Tiempos", y = "Tiempo") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Gráfico de Tiempos', fig.id='ViolinT', fig.topcaption=TRUE}
filter(var_pts, !variables %in% c("Demanda", "Densidad")) %>%
  ggplot(aes(variables, valor, fill = "variables")) +
  geom_violin(width = .3, fill = "lightblue") +
  xlab("") +
  ylab("Tiempo") +
  labs(title="Gráfico de Tiempos", y = "Tiempo") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Distribución de Tiempos', fig.id='Distr', fig.topcaption=TRUE}
filter(var_pts, !variables %in% c("Demanda", "Densidad")) %>%
    ggplot(aes(valor, fill = variables, colour = variables)) +
    geom_density(alpha = .5) +
    xlab("Tiempo") +
    ylab("Densidad") +
    labs(title="Distribución de Tiempos") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

Se observa que las variables relevantes para aplicar un modelo son tiempo de viaje, tarifa, tiempo de acceso y tiempo de egreso. Que no sea tan relevante el tiempo de transbordo, caminata y tiempo de espera, puede tener su explicación en la combinación de rutas ya está detectada a través de la data, y los usuarios escogen la combinación que minimizen esos tiempos.


## 4.1 Asignación de Demanda en Zonificación Base

Para aplicar el modelo de ML es necesario darle más variabilidad a los datos, por eso en vez de considerar el promedio día se obtienen los viajes para todos los días de la semana, que correponde del del 8 al 12 de abril de 2019. Estos datos fueron pasados igualmente por el proceso de limpieza e imputación anteriormente mencionados, adicionalmente se agrega la variable tarifa que diferenciará aquellos viajes que son realizados solo por bus, metro o combinación de ambos, con esto, los viajes en el área de estudio pasaron de 347,023 registros a 552,982.

````{r, echo = F, message = F, warning = F, fig.cap='Diagrama de Caja de Demanda', fig.id='DCajaDemAsig', fig.topcaption=TRUE}
var_trips <- pivot_longer(zoi_tripsDayCG, 
             !c("rts", "netapa", "DIA", "Tarifa"), 
             names_to = "variables", 
             values_to = "valor") %>% 
    mutate(variables = factor(variables))

filter(var_trips, variables == "Demanda", valor < 2) %>%
    ggplot(aes(variables, valor, fill = "variables")) +
    geom_boxplot(width = .3, fill = "#FFC300") +
  facet_wrap(~Tarifa) +
    labs(title="Diagrama de Caja de Demanda", x = "", y = "Validaciones") +
    theme(plot.title = element_text(hjust = 0.5), axis.text.x=element_blank(), axis.ticks.x=element_blank())
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Gráfico de Demanda', fig.id='ViolinDemAsig', fig.topcaption=TRUE}
filter(var_trips, variables == "Demanda" & valor < 2) %>%
    ggplot(aes(variables, valor, fill = "variables")) +
    geom_violin(width = .3, fill = "lightblue") +
  facet_wrap(~Tarifa) +
    labs(title="Gráfico de Demanda", y = "Validaciones") +
    theme(plot.title = element_text(hjust = 0.5), 
          axis.text.x=element_blank(), 
          axis.ticks.x=element_blank())
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Distribución de Demanda', fig.id='DistrDem', fig.topcaption=TRUE}
filter(var_trips, variables == "Demanda" & valor < 2) %>%
    ggplot(aes(valor, fill = variables, colour = variables)) +
    geom_density(alpha = .5, show.legend = F, color="black", fill="lightblue") +
  facet_wrap(~Tarifa) +
    labs(title="Distribución de Demanda", x = "", y = "Densidad") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Diagrama de Caja de Tiempos', fig.id='DCajaTAsig', fig.topcaption=TRUE}

filter(var_trips, !variables %in% c("Demanda", "Tarifa") & valor < 60) %>%
  ggplot(aes(variables, valor, fill = "variables")) +
  geom_boxplot(width = .3, fill = "#FFC300") +
  facet_wrap(~Tarifa) +
  xlab("") +
  ylab("Tiempo") +
  labs(title="Diagrama de Caja de Tiempos", y = "Tiempo") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Gráfico de Tiempos', fig.id='ViolinTAsig', fig.topcaption=TRUE}
filter(var_trips, !variables %in% c("Demanda", "Tarifa") & valor < 60) %>%
    ggplot(aes(variables, valor, fill = "variables")) +
    geom_violin(width = .3, fill = "lightblue") +
  facet_wrap(~Tarifa) +
    labs(title="Gráfico de Tiempos", y = "Validaciones") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Distribución de Tiempos', fig.id='Distr', fig.topcaption=TRUE}
filter(var_trips, !variables %in% c("Demanda", "Tarifa") & valor < 20) %>%
    ggplot(aes(valor, fill = variables, colour = variables)) +
    geom_density(alpha = .5) +
  facet_wrap(~Tarifa) +
    xlab("Tiempo") +
    ylab("Densidad") +
    labs(title="Distribución de Tiempos") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Demanda por Tiempo de Viaje', fig.id='Dem_tviaje', fig.topcaption=TRUE}
ggplot(zoi_tripsDayCG, aes(log1p(tviaje), Demanda, color = factor(Tarifa))) +
  geom_point() +
  facet_wrap(~netapa) +
  scale_color_brewer(palette="Dark2", name = "Tarifa") +
  labs(title="Demanda por Tiempo de viaje", x = "Tiempo de Viaje") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Demanda por Tiempo de Espera', fig.id='Dem_tesp', fig.topcaption=TRUE}
ggplot(zoi_tripsDayCG, aes(tesp, Demanda, color = factor(Tarifa))) +
  geom_point() +
  facet_wrap(~netapa) +
  scale_color_brewer(palette="Dark2", name = "Tarifa") +
  labs(title="Demanda por Tiempo de Espera", x = "Tiempo de Espera") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Demanda por Tiempo de Caminata', fig.id='Dem_tcam', fig.topcaption=TRUE}
ggplot(zoi_tripsDayCG, aes(tcam, Demanda, color = factor(Tarifa))) +
  geom_point() +
  facet_wrap(~netapa) +
  scale_color_brewer(palette="Dark2", name = "Tarifa") +
  labs(title="Demanda por Tiempo de Caminata", x = "Tiempo de Caminata") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Demanda por Tiempo de Transbordo', fig.id='Dem_tb2', fig.topcaption=TRUE}

ggplot(zoi_tripsDayCG, aes(tb2, Demanda, color = factor(Tarifa))) +
  geom_point() +
  facet_wrap(~netapa) +
  scale_color_brewer(palette="Dark2", name = "Tarifa") +
  labs(title="Demanda por Tiempo de Transbordo", x = "Tiempo de Transbordo") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Demanda por Tiempo de Acceso', fig.id='Dem_tacc', fig.topcaption=TRUE}
ggplot(zoi_tripsDayCG, aes(log1p(time_acc), Demanda, color = factor(Tarifa))) +
  geom_point() +
  facet_wrap(~netapa) +
  scale_color_brewer(palette="Dark2", name = "Tarifa") +
  labs(title="Demanda por Tiempo de Acceso", x = "Tiempo de Acceso") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Demanda por Tiempo de Egreso', fig.id='Dem_tegg', fig.topcaption=TRUE}
ggplot(zoi_tripsDayCG, aes(log1p(time_egg), Demanda, color = factor(Tarifa))) +
  geom_point() +
  facet_wrap(~netapa) +
  scale_color_brewer(palette="Dark2", name = "Tarifa") +
  labs(title="Demanda por Tiempo de Egreso", x = "Tiempo de Egreso") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

Dado la distribución de las variables y su relación con la Demanda, se realiza un modelo Random Forest bajo la siguiente definición:

$Demanda = log(1+t_{viaje}) + log(1+t_{acc}) + log(1+t_{egg}) + Tarifa + netapa + \epsilon$

Se consideran los datos de entrenamiento como el 75% del total de la muestra, que son estratificados por el número de etapas de viaje.

Los hiperparámetros son:

- Número de árboles: 1000
- Mtry: 2

Los estadísticos resultantes son:

$R^2 (OOB) = 0.51$
OOB prediction error (MSE): 82.2

También se aprecia una relación lineal entre la Demanda y la predicción.

````{r, echo = F, message = F, warning = F, fig.cap='Demanda vs Predicción', fig.id='PredAsig', fig.topcaption=TRUE}
ggplot(rf_testing_pred, aes(y = Demanda, x = .pred)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y~x) +
  facet_wrap(~Tarifa) +
  labs(title="Predicción de Demanda", x = "Predicción") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

Y el error presenta una distribución normal centrada en 0.

````{r, echo = F, message = F, warning = F, fig.cap='Distribución del Error', fig.id='DistrErr', fig.topcaption=TRUE}
ggplot(rf_testing_pred, aes(Demanda - .pred)) +
    geom_density(alpha = .5, fill = "lightblue") +
  facet_wrap(~Tarifa) +
    xlab("Demanada - Predicción") +
    ylab("Densidad") +
    labs(title="Distribución del Error") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

Para todos los datos, el resultado es el que se muestra a continuación:

````{r, echo = F, message = F, warning = F, fig.cap='Demanda vs Predicción', fig.id='PredAsigAll', fig.topcaption=TRUE}
ggplot(rf_all_pred, aes(y = Demanda, x = .pred)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y~x) +
  facet_wrap(~Tarifa) +
  labs(title="Predicción de Demanda", x = "Predicción") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

Y el error presenta una distribución normal centrada en 0.

````{r, echo = F, message = F, warning = F, fig.cap='Distribución del Error', fig.id='DistrErrAll', fig.topcaption=TRUE}
ggplot(rf_all_pred, aes(Demanda - .pred)) +
    geom_density(alpha = .5, fill = "lightblue") +
  facet_wrap(~Tarifa) +
    xlab("Demanada - Predicción") +
    ylab("Densidad") +
    labs(title="Distribución del Error") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

## 4.2 Resultados y Análisis de Sensibilidad

La cantidad de paradas por zona se distribuyen de la siguiente manera.

````{r, echo = F, message = F, warning = F, fig.cap='Diagrama de Cajas de Paradas por Zona', fig.id='boxplot_parZon', fig.topcaption=TRUE}
ggplot(npts_zn, aes(y = n)) +
    geom_boxplot(width = .3, fill = "#FFC300") +
    xlab("") +
    ylab("Cantidad de Paradas") +
    labs(title="Diagrama de Cajas de Paradas por Zona", y = "Cantidad") +
    theme(plot.title = element_text(hjust = 0.5), axis.ticks.x=element_blank(), axis.text.x=element_blank())
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Distribución de Paradas por Zona', fig.id='Dens_parZon', fig.topcaption=TRUE}

ggplot(npts_zn, aes(n)) +
    geom_density(alpha = .5, fill = "lightblue") +
    xlab("Cantidad por Zona") +
    ylab("Densidad") +
    labs(title="Distribución de Paradas por Zona") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

Nos indica que en su mayoría, las zonas contienen alrededor de 12 paradas y como nos interesa solo aquellas zonas en que se pueda hacer una clusterización, filtramos las que tengan más de 2 paradas, es decir, trabajaremos efectivamente con 465 zonas.

Para encontrar el óptimo de cluster por zona, se usa el estadístico *gap*, en su implementación se considera como máximo número de clusters la cantidad de paradas por zona menos 1, el número de muestras Monte Carlo en 50, el número de "comienzos" aleatorios está en 25 y el método utilizado fue el de máximo global.

Como resultado las 866 zonas se transforman en 4,144, es decir, las 483 zonas del área de estudio se transforman en 3,624.

`````{r, echo = F, message = F, warning = F, fig.cap='Nueva Zonificación', fig.id='NewZ', fig.topcaption=TRUE}
DemZon1 <- st_join(final_zon, 
                  select(stops_trips, Demanda), 
                  .predicate = st_within) %>% 
  group_by(Zona, Zona2) %>% 
  summarise(Demanda = sum(Demanda))

tm_shape(zoi) + 
  tm_polygons() + 
  tm_shape(DemZon1) +
    tm_grid(col = "white", lwd = 2, labels.size = .5, n.x = 4) +
    tm_polygons(col = "Demanda", style = "quantile", palette = "viridis", border.alpha = .1) + 
    tm_shape(zones) + 
    tm_polygons(col = "gray", alpha = .3) +
    tm_layout(bg.color = "lightblue", 
              main.title = "Generación de Demanda", 
              main.title.position = "center", 
              main.title.size = 1.1, 
              legend.outside = TRUE) +
    tm_compass(position = c("left", "top"), type = "8star", size = 3) +
    tm_scale_bar(position = c("right", "bottom"))  
````
Fuente: Elaboración Propia

Análisis de Sensibilidad

a) Generador de número aleatorio

Dado que la obtención del número de cluster está fundamentado en un muestreo, es necesario fijar una "semilla" que contengan los mismos números aleaotorios cada vez que se repita el proceso, de ese modo se asegura los mismos resultados. Para la obtención de la zonificación, se configuró en la semilla "123". Si cambiamos el número de semilla, como resultado entregará distinto número de zonas. Para la semilla "4568" genera 4118 zonas, es decir 26 zonas menos.

`````{r, echo = F, message = F, warning = F, fig.cap='sensibilidad Semilla', fig.id='new_seed', fig.topcaption=TRUE}
DemZon1 <- st_read("../output/zoning_seed.gpkg", quiet = T) %>%
  st_join(select(stops_trips, Demanda), 
                  .predicate = st_within) %>% 
  group_by(Zona, Zona2) %>% 
  summarise(Demanda = sum(Demanda))

tm_shape(zoi) + 
  tm_polygons() + 
  tm_shape(DemZon1) +
    tm_grid(col = "white", lwd = 2, labels.size = .5, n.x = 4) +
    tm_polygons(col = "Demanda", style = "quantile", palette = "viridis", border.alpha = .1) + 
    tm_shape(zones) + 
    tm_polygons(col = "gray", alpha = .3) +
    tm_layout(bg.color = "lightblue", 
              main.title = "Generación de Demanda", 
              main.title.position = "center", 
              main.title.size = 1.1, 
              legend.outside = TRUE) +
    tm_compass(position = c("left", "top"), type = "8star", size = 3) +
    tm_scale_bar(position = c("right", "bottom"))  
````

b) Número de comienzos aleatorios

La experiencia de otras aplicaciones señala que la estabilidad de alguna simulación es a partir de 20, como se mencionó inicialmente, el número utilizado para este parámetro fue de 25, el que se cambió a 5 para visualizar algún efecto, sin embargo, no produjo ningún cambio en el número de zonas resultantes.

c) Umbral de mínimo de paradas por zona.

Como primer análisis de sensibilidad es consideramos cuanto cambia la cantidad de zonas de la nueva zonificación si tomamos en cuenta solo aquellas que sobrepasen el primer quartil, es decir, se aplica el proceso para aquellas zonas que contengan mayor a 8 paradas. Como resultado se obtienen 3,914 zonas.

`````{r, echo = F, message = F, warning = F, fig.cap='Umbral de Paradas', fig.id='threshold', fig.topcaption=TRUE}
DemZon1 <- st_read("../output/zoning_threshold.gpkg", quiet = T) %>%
  st_join(select(stops_trips, Demanda), 
                  .predicate = st_within) %>% 
  group_by(Zona, Zona2) %>% 
  summarise(Demanda = sum(Demanda))

tm_shape(zoi) + 
  tm_polygons() + 
  tm_shape(DemZon1) +
    tm_grid(col = "white", lwd = 2, labels.size = .5, n.x = 4) +
    tm_polygons(col = "Demanda", style = "quantile", palette = "viridis", border.alpha = .1) + 
    tm_shape(zones) + 
    tm_polygons(col = "gray", alpha = .3) +
    tm_layout(bg.color = "lightblue", 
              main.title = "Generación de Demanda", 
              main.title.position = "center", 
              main.title.size = 1.1, 
              legend.outside = TRUE) +
    tm_compass(position = c("left", "top"), type = "8star", size = 3) +
    tm_scale_bar(position = c("right", "bottom"))  
````

d) Cambiar el máximo número de cluster

Estamos considerando como máximo número de cluster la cantidad total de paradas menos uno, ahora cambiando ese parámetro por que el máximo sea el 80%, es decir, que si tenemos 100 paradas, como máximo habrán 80 clusters. Esto entrega como resultado 3,641 zonas.

`````{r, echo = F, message = F, warning = F, fig.cap='Máximo de Cluster', fig.id='clus_max', fig.topcaption=TRUE}
DemZon1 <- st_read("../output/zoning_max.gpkg", quiet = T) %>%
  st_join(select(stops_trips, Demanda), 
                  .predicate = st_within) %>% 
  group_by(Zona, Zona2) %>% 
  summarise(Demanda = sum(Demanda))

tm_shape(zoi) + 
  tm_polygons() + 
  tm_shape(DemZon1) +
    tm_grid(col = "white", lwd = 2, labels.size = .5, n.x = 4) +
    tm_polygons(col = "Demanda", style = "quantile", palette = "viridis", border.alpha = .1) + 
    tm_shape(zones) + 
    tm_polygons(col = "gray", alpha = .3) +
    tm_layout(bg.color = "lightblue", 
              main.title = "Generación de Demanda", 
              main.title.position = "center", 
              main.title.size = 1.1, 
              legend.outside = TRUE) +
    tm_compass(position = c("left", "top"), type = "8star", size = 3) +
    tm_scale_bar(position = c("right", "bottom"))  
````

e) Cambiar la cantidad de muestras de MonteCarlo

Se consideraron como parámetro unas 50 muestras de montecarlo, para ver la estabilidad se cambió a 5 muestras. Este tiene tiene un mayor efecto en el número de zonas, generándose 4,221. 
`````{r, echo = F, message = F, warning = F, fig.cap='Cantidad de Muestras', fig.id='clus_max', fig.topcaption=TRUE}
DemZon1 <- st_read("../output/zoning_mc.gpkg", quiet = T) %>%
  st_join(select(stops_trips, Demanda), 
                  .predicate = st_within) %>% 
  group_by(Zona, Zona2) %>% 
  summarise(Demanda = sum(Demanda))

tm_shape(zoi) + 
  tm_polygons() + 
  tm_shape(DemZon1) +
    tm_grid(col = "white", lwd = 2, labels.size = .5, n.x = 4) +
    tm_polygons(col = "Demanda", style = "quantile", palette = "viridis", border.alpha = .1) + 
    tm_shape(zones) + 
    tm_polygons(col = "gray", alpha = .3) +
    tm_layout(bg.color = "lightblue", 
              main.title = "Generación de Demanda", 
              main.title.position = "center", 
              main.title.size = 1.1, 
              legend.outside = TRUE) +
    tm_compass(position = c("left", "top"), type = "8star", size = 3) +
    tm_scale_bar(position = c("right", "bottom"))  
````

## 4.3 Asignación de Demanda en Nueva Zonificación

Para evaluar el efecto en la Asignación de Demanda mediante modelo Random Forest, el efecto estará principalmente en los nuevos tiempos de acceso y egreso. Con el nuevo esquema de zonificación se procedió a calcular los nuevos caminos más cortos para los inicios y fin de viaje, obteniéndose el comportamiento que se detalla a continuación.

````{r, echo = F, message = F, warning = F, fig.cap='Diagrama de Caja de Tiempos', fig.id='New_times', fig.topcaption=TRUE}
var_trips <- pivot_longer(zoi_tripsDayCG_newzone, 
             !c("rts", "netapa", "DIA", "Tarifa"), 
             names_to = "variables", 
             values_to = "valor") %>% 
    mutate(variables = factor(variables))

filter(var_trips, variables %in% c("time_acc", "time_egg") & valor < 60) %>%
    ggplot(aes(variables, valor, fill = "variables")) +
    geom_boxplot(width = .3, fill = "#FFC300") +
  facet_wrap(~Tarifa) +
    labs(title="Diagrama de Caja de Tiempos", x = "", y = "Validaciones") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Gráfico de Tiempos', fig.id='ViolinT2', fig.topcaption=TRUE}
filter(var_trips, variables %in% c("time_acc", "time_egg") & valor < 60) %>%
    ggplot(aes(variables, valor, fill = "variables")) +
    geom_violin(width = .3, fill = "lightblue") +
  facet_wrap(~Tarifa) +
    labs(title="Gráfico de Tiempos", y = "Validaciones") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Distribución de Tiempos', fig.id='DistrT2', fig.topcaption=TRUE}
filter(var_trips, variables %in% c("time_acc", "time_egg") & valor < 60) %>%
    ggplot(aes(valor, fill = variables, colour = variables)) +
    geom_density(alpha = .5) +
  facet_wrap(~Tarifa) +
    xlab("Tiempo") +
    ylab("Densidad") +
    labs(title="Distribución de Tiempos") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Demanda por Tiempo de Acceso', fig.id='Dem_tacc2', fig.topcaption=TRUE}
ggplot(zoi_tripsDayCG, aes(log1p(time_acc), Demanda, color = factor(Tarifa))) +
  geom_point() +
  facet_wrap(~netapa) +
  scale_color_brewer(palette="Dark2", name = "Tarifa") +
  labs(title="Demanda por Tiempo de Acceso", x = "Tiempo de Acceso") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

````{r, echo = F, message = F, warning = F, fig.cap='Demanda por Tiempo de Egreso', fig.id='Dem_tegg2', fig.topcaption=TRUE}
ggplot(zoi_tripsDayCG, aes(log1p(time_egg), Demanda, color = factor(Tarifa))) +
  geom_point() +
  facet_wrap(~netapa) +
  scale_color_brewer(palette="Dark2", name = "Tarifa") +
  labs(title="Demanda por Tiempo de Egreso", x = "Tiempo de Egreso") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

Para comparar los resultados apropiadamente se replica la misma estrategia de modelación, que consiste en que los datos de entrenamiento corresponden al 75% de la muestra, que son estratificados por el número de etapas de viaje, con los siguientes hiperparámetros:

- Número de árboles: 1000
- Mtry: 2

Los estadísticos resultantes son:

$R^2 (OOB) = 0.41$
OOB prediction error (MSE): 100.4

Para la muestra de validación, hay una relación lineal entre la Demanda y la predicción.

````{r, echo = F, message = F, warning = F, fig.cap='Demanda vs Predicción', fig.id='PredAsig2', fig.topcaption=TRUE}
ggplot(rf_testing_pred, aes(y = Demanda, x = .pred)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y~x) +
  facet_wrap(~Tarifa) +
  labs(title="Predicción de Demanda", x = "Predicción") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

Y el error presenta una distribución normal centrada en 0.

````{r, echo = F, message = F, warning = F, fig.cap='Distribución del Error', fig.id='DistrErr', fig.topcaption=TRUE}
ggplot(rf_testing_pred, aes(Demanda - .pred)) +
    geom_density(alpha = .5, fill = "lightblue") +
  facet_wrap(~Tarifa) +
    xlab("Demanada - Predicción") +
    ylab("Densidad") +
    labs(title="Distribución del Error") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

Para todos los datos, el resultado no es muy distinto:

````{r, echo = F, message = F, warning = F, fig.cap='Demanda vs Predicción', fig.id='PredAsig2', fig.topcaption=TRUE}
ggplot(rf_all_pred, aes(y = Demanda, x = .pred)) +
  geom_point() +
  geom_smooth(method = "lm", formula = y~x) +
  facet_wrap(~Tarifa) +
  labs(title="Predicción de Demanda", x = "Predicción") +
  theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia

Y el error presenta una distribución normal centrada en 0.

````{r, echo = F, message = F, warning = F, fig.cap='Distribución del Error', fig.id='DistrErr', fig.topcaption=TRUE}
ggplot(rf_all_pred, aes(Demanda - .pred)) +
    geom_density(alpha = .5, fill = "lightblue") +
  facet_wrap(~Tarifa) +
    xlab("Demanada - Predicción") +
    ylab("Densidad") +
    labs(title="Distribución del Error") +
    theme(plot.title = element_text(hjust = 0.5))
````
Fuente: Elaboración Propia
\newpage

# CAPÍTULO 5: CONCLUSIONES Y RECOMENDACIONES

## 5.1 Conclusiones

Respecto a la Hipótesis y los Objetivos:

Respecto a la hipótesis podemos separar en dos, señalando que si es posible desagregar la demanda zonal utilizando metodología que implique bajo nivel de costo y precisión en la estimación de demanda a servicios, considerando la localización de paradas como indicador espacial de la concentración de demanda, sin embargo, no mejora los resultados de la asignación de rutas si su metodología de estimación es a través de un modelo de Machine Learning, en particular, Random Forest, la diferencia en la variabilidad por modificar la zonificación no genera una diferencia significativa a pesar que son muchas más zonas, se evidencia que permance una proporcionalidad que no cambia su variabilidad. Que no es el caso de otras experiencias en zonificación, por ejemplo en la metodología de @Ghadiri2019 la evaluación se hizo mediante regresiones lineales zonales según propósitos de viaje que entregó resultados relativamente mejores, otras alternativas son como las que presenta @Binetti donde la comparación es mediante la aplicación de modelos clásicos de asignación de transporte. 

## 5.2 Recomendaciones

Se puede obtener variación de la zonificación mediante el uso de otro tipo de distancia en el cálculo de polígonos de Voronoi, por ejemplo, usando distancias Manhattan en vez de Euclideanas.

Otro método de cluterización , que no sea Ward (aumento de la varianza en la unión de clusters).

\newpage

# BIBLIOGRAFÍA